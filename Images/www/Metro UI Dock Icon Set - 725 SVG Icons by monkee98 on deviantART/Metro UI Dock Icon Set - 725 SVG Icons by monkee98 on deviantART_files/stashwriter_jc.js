/*
 *  (c) 2000-2014 deviantART, Inc. All rights reserved.
 */
LocalStorageDaemon=function(){this.ls=window.localStorage||(window.globalStorage||{})[location.hostname],this.check()},LocalStorageDaemon.prototype={_getMain:function(){try{this._lsdata=this.ls&&JSON.parse(this.ls.getItem("lsd"))||{}}catch(t){console.log(t),this._lsdata={}}return this._lsdata},_updateMain:function(){if(!this._lsdata)throw"LSD Not Ready";this.ls&&(this.ls.removeItem("lsd"),this.ls.setItem("lsd",JSON.stringify(this._lsdata)))},isEnabled:function(){return Boolean(this.ls)},getItem:function(t){return(this._getMain()[t]||{}).content},removeItem:function(t){delete this._getMain()[t],this._updateMain()},setObject:function(t,e,n){return this.setItem(t,e,n)},getObject:function(t){return this.getItem(t)},setItem:function(t,e,n){this._getMain()[t]={content:e,ts:(new Date).valueOf()+Number(n||12e5)},this._updateMain()},check:function(){var t,e,n,i;n=(new Date).valueOf(),t=this._getMain(),i=[];for(e in t)n>t[e].ts&&i.push(e);for(e in i)this.removeItem(e)}},DWait.ready("jms/lib/json2.js",function(){window.LSD=new LocalStorageDaemon}),window.DWait&&DWait.run("jms/lib/lsd.js");
var rangeInNode=function(e,t){var n=e.commonAncestorContainer;do if(n==t)return!0;while(n=n.parentNode);return!1},getRangeForCaret=function(e){if(window.getSelection&&window.getSelection().rangeCount){var t=window.getSelection().getRangeAt(0);if(t.collapsed&&rangeInNode(t,e))return t.cloneRange()}},getWordFromRange=function(e){return e.startContainer.textContent.substring(0,e.startOffset).split(/\s+|\>|\b(?=@)/g).pop()},expandRangeToWord=function(e){var t=getWordFromRange(e),n=e.startOffset;e.setStart(e.startContainer,n-t.length),e.setEnd(e.startContainer,n)};window.Carotid={getWord:function(e){var t=getRangeForCaret(e);return t?getWordFromRange(t):""},setWord:function(e,t,n){var r=getRangeForCaret(e);if(r){expandRangeToWord(r),r.deleteContents();var o;n&&(o=$('<span class="dautocomplete_space">&nbsp;</span>')[0],r.insertNode(o));var a=document.createTextNode(t);r.insertNode(a),r.setStartAfter(o||a),r.setEndAfter(o||a);var i=window.getSelection();i.removeAllRanges(),i.addRange(r)}},getWordBoundingRect:function(e){var t=getRangeForCaret(e);return t?(expandRangeToWord(t),t.getBoundingClientRect()):void 0},getNode:function(e){var t=getRangeForCaret(e);return t?t.commonAncestorContainer:void 0}},window.DWait&&DWait.run("jms/lib/carotid.js");
DWait.ready(["jms/lib/Base.js","jms/lib/popup2.js","jms/lib/carotid.js"],function(){var e,t=function(e){return!!(e||"").match(/[a-z0-9\-]{3,20}/i)},s=function(e){for(var t=e;(t=t.parentNode)&&"visible"==$(t).css("overflow"););var s=$(e),i=$(t),o=$(t).scrollTop(),n=o+i.outerHeight(),r=e.offsetTop,a=r+s.outerHeight();o>r?i.scrollTop(r):a>n&&i.scrollTop(a-i.outerHeight())},i={},o=function(s){var o=$.Deferred(),n=[];e||(e={},$(".username-with-symbol").filter(function(){return!$(this).closest("#depths").length}).each(function(){var s=$(".username",this).text().toLowerCase();if(t(s)&&!e[s]){var i=$('.avatar[title="'+s+'"]').attr("src");i||n.push(s),e[s]={markup:PHP.userlink(s),username:s,iconurl:i}}}));var r=[],a=$.Deferred();n.length?DiFi.pushPost("User","getDetailsByUsername",[n],function(t,s){return t?($.each(s.response.content,function(t,s){e[t.toLowerCase()]={markup:s.link,iconurl:s.avatar,username:s.username}}),a.resolve(),void 0):a.resolve()}):a.resolve(),r.push(a);var h=s[0];if(window.deviantART.deviant.loggedIn&&h&&i[h]!==!0){var c=$.Deferred();DiFi.pushPrivateGet("Friends","getFriendsForLetter",[h,i[h]||0],function(t,o){return t?(i[s[0]]=o.response.content.has_more?o.request.args[1]+1:!0,$.each(o.response.content.friends,function(t,s){e[s.username.toLowerCase()]={markup:PHP.userlink(s.username),username:s.username,iconurl:s.avatar}}),c.resolve(),void 0):c.resolve()}),i[s[0]]=!0,r.push(c)}return $.when.apply($,r).then(function(){o.resolve(e)}),DiFi.send(),o},n=0;window.DAutoComplete=Base.extend({constructor:function(e,t){this.priority_users=t||[],this.$=$('<div class="dautocomplete"></div>'),this.popup=new Popup2("dautocomplete"+ ++n,"body",{content:this.$,classes:"dautocomplete",events:[{selector:".item",event:"mousedown",callback:bind(this,this.mouseDown)},{selector:".item",event:"mouseover",callback:bind(this,this.mouseOver)}]}),$("#output, #dv7, .bubbleview, .stash-container").on("scroll",$.throttle(50,bind(this,function(){this.isShown()&&$("body").is(".ccwriter-subframe")&&this.show()}))),this.watching=$(e).on("keydown.dauto",bind(this,this.keyDown)).on("keyup.dauto",bind(this,this.keyUp)).on("paste.dauto",bind(this,this.show)).on("writereditcomplete.dauto",bind(this,this.show))},destructor:function(){this.watching&&this.watching.off(".dauto")},show:function(){var e=Carotid.getNode(this.watching[0]);if(!e||$(e).closest("a").length)return this.hide();var t=Carotid.getWord(this.watching[0]);return ddt.log("dautocomplete","Considering showing",t),t&&"@"===t[0]?(this.$.find(".selected").removeClass("selected"),this.$.find(".item:first").addClass("selected"),this.renderHTML(t.substr(1)),this.position(),void 0):this.hide()},position:function(){var e=Carotid.getWordBoundingRect(this.watching[0]);ddt.log("dautocomplete","Showing",e);var t={left:e.left+window.pageXOffset-document.documentElement.clientLeft,top:e.bottom+window.pageYOffset-document.documentElement.clientTop},s=this.$.width()||300,i=this.$.height()||300;t.left+s>$(document).width()&&(t.left-=s),t.top+i>$(document).height()&&(t.top-=i+e.height+10),this.popup.show(t)},hide:function(){ddt.log("dautocomplete","Hiding"),this.check_delay=clearTimeout(this.check_delay),this.popup.hide()},isShown:function(){return this.popup.visible()},confirm:function(){var e=this.$.find(".selected .username").text();Carotid.setWord(this.watching[0],"@"+e,!0),this.hide()},keyDown:function(e){switch(e.which){case 27:this.isShown()&&(e.preventDefault(),this.hide());break;case 37:case 39:this.isShown()&&this.hide();break;case 38:case 40:if(this.isShown()){var t;1===this.$.find(".item").length?this.$.find(".selected").addClass("selected"):(t=this.$.find(".selected")[38==e.keyCode?"prev":"next"](),t.length&&(this.$.find(".selected").removeClass("selected"),t.addClass("selected"),s(t[0]))),e.preventDefault()}break;case 32:this.hide();break;case 13:case 10:case 9:this.isShown()&&(this.confirm(),this.hide(),e.stopImmediatePropagation(),e.preventDefault())}},keyUp:function(e){switch(e.which){case 39:case 37:case 38:case 40:case 13:case 10:case 9:case 27:case 91:case 93:case 16:case 17:case 18:return;default:this.show()}},renderHTML:function(s,i){var n=[],r=RegExp("^"+s,"i"),a=this;s!==this.last_word&&(this.check_delay=clearTimeout(this.check_delay)),this.last_word=s;var h;if(i||(h=o(s).done(function(){a.isShown()&&(a.renderHTML(s,!0),a.position(),s&&t(s)&&void 0===e[s.toLowerCase()]&&(a.check_delay=setTimeout(function(){a.check_delay=void 0,a.isShown()&&(DiFi.pushPost("User","getDetailsByUsername",[[s]],function(t,i){return e[s.toLowerCase()]=!1,t?($.each(i.response.content,function(t,s){e[t.toLowerCase()]={markup:s.link,iconurl:s.avatar,username:s.username,low_priority:!0}}),a.isShown()&&a.renderHTML(s,!0),void 0):a.renderHTML(s,!0)}),DiFi.send())},600)))})),e){var c=[];$.each(e,function(e,t){t&&r.test(e)&&c.push(e)}),c.sort(function(t,i){var o=$.inArray(t,a.priority_users),n=$.inArray(i,a.priority_users);return o>-1&&n>-1?o-n:o>-1&&-1==n?-1:n>-1&&-1==o?1:(t=t.toLowerCase(),i=i.toLowerCase(),e[t].low_priority?1:e[i].low_priority?-1:t==s.toLowerCase()?1:i==s.toLowerCase()?-1:i>t?-1:t>i?1:0)});for(var d=0;c.length>d;d++){var u=c[d],l=e[u.toLowerCase()];n.push('<div class="item"><img width="20" height="20" src="'+(l.iconurl||"about:blank")+'"> '+l.markup+"</div>")}}(this.check_delay||h&&"resolved"!==h.state())&&n.push('<div class="noresults loading">Searching...</div>'),0===n.length&&n.push('<div class="noresults">No deviants found</div>'),this.$.html(n.join("")),this.$.find(".selected").removeClass("selected"),this.$.find(".item:first").addClass("selected")},mouseOver:function(e){return this.$.find(".selected").removeClass("selected"),$(e.target).closest(".item").addClass("selected"),!1},mouseDown:function(e){return 1===e.which&&(this.confirm(),e.preventDefault()),!1}}),window.DWait&&DWait.run("jms/lib/autocomplete.js")});
WriterEmbed=function(){function t(t){return/^(?:https?:)?\/\//i.test(t)?(t=$("<a>",{href:t})[0],{href:t.href,hash:t.hash,hostname:t.hostname,pathname:t.pathname,search:t.search,params:function(){for(var e={},i=t.search.slice(1).split("&"),r=0;i.length>r;r++){var a=i[r].split("=");e[decodeURIComponent(a[0]||"")]=decodeURIComponent(a[1]||"")}return e}()}):!1}function e(e){if(e=t(e)){var i,r=e.hostname.split(".").slice(-2).join(".");return"deviantart.com"==r||"deviantart.com"==r?(i=e.hash.match(/^#\/d(\w+)$/),i?i=parseInt(i[1],36):(i=e.pathname.match(/^\/(?:art|journal)\/[^\/]+?-(\d+)\/?$/),i&&(i=+i[1]))):"sta.sh"==r||"sta.sh"==r?(i=(e.hash.match(/^#\/d(\w+)$/)||e.pathname.match(/^\/0(\w+)\/?$/)||[])[1],i&&(i=parseInt(i,36))):"fav.me"==r&&(i=(e.pathname.match(/^\/d(\w+)$/)||[])[1],i&&(i=parseInt(i,36))),i||null}}function i(t,e){var i="http://backend.deviantart.com/oembed?url="+encodeURIComponent(t)+"&format=jsonp"+"&prefer_rich=1",r=$.Deferred();e=e||!1;var a=e?null:G[i];return a&&a.response?r.resolve(a.response):a&&a.error?r.resolve(a.error):$.ajax({url:i,timeout:5e3,dataType:"jsonp"}).done(function(t){t&&!t.error?(G[i]={response:t},r.resolve(t)):(G[i]={error:t},r.reject(t))}).fail(function(t,e,a){G[i]={error:a},r.reject(a)}),r}function r(t,e){var i,r=/redraw\/embed/.test(t.html),a=!r&&"video"==t.type,d="emoticon"==e.type;if(e.type="deviation","auto"==e.format&&(r?e.format="image":delete e.format),d){if(t.width*t.height>2500)return $("<img>");e.type="emoticon",i=$("<img>").attr({src:t.fullsize_url||t.url,width:t.width,height:t.height,alt:t.title})}else t.html&&!e.format?(a||(e.height=e.height||300),i=$("<div>",{"class":"writer-deviation-iframe",width:a?480:e.width||"",height:a?320:e.height}).append("<div>").append($(t.html).addClass("never-hide-me").removeAttr("style"))):!t.url&&!t.fullsize_url||e.format&&"image"!=e.format?t.thumbnail_url&&"bigthumb"==e.format?(i=$("<img>",{"class":"writer-deviation-thumbnail",src:t.thumbnail_url}),delete e.width,delete e.height,e.naturalwidth=t.width,e.naturalheight=t.height):t.thumbnail_url_200h&&"200H"==e.format?(i=$("<img>",{"class":"writer-deviation-thumbnail",src:a?t.thumbnail_url:t.thumbnail_url_200h,css:{width:a?150:null}}),delete e.width,delete e.height,e.thumb200width=t.thumbnail_width_200h,e.thumb200height=t.thumbnail_height_200h,e.naturalwidth=t.width,e.naturalheight=t.height):!t.thumbnail_url_150||"200H"!=e.format&&"thumb"!=e.format?!t.thumbnail_html||"200H"!=e.format&&"thumb"!=e.format||(i=$(t.thumbnail_html).addClass("writer-deviation-lit-thumbnail")):(i=$("<img>",{"class":"writer-deviation-thumbnail",src:a?t.thumbnail_url:t.thumbnail_url_150,css:{width:a?150:null}}),delete e.width,delete e.height,e.naturalwidth=t.width,e.naturalheight=t.height):(i=$("<img>",{"class":"writer-deviation-image",src:t.fullsize_url||t.url,width:e.width}),e.thumb200width=t.thumbnail_width_200h,e.thumb200height=t.thumbnail_height_200h,e.naturalwidth=t.fullsize_width||t.width,e.naturalheight=t.fullsize_height||t.height);return i&&(r&&(e.type="drawing"),i.addClass("writer-embed").attr({contenteditable:i.is("img")?null:"false","data-embed-type":e.type,"data-embed-id":e.id,"data-embed-width":e.width,"data-embed-height":e.height,"data-embed-url":e.url,"data-embed-title":e.title||t.title,"data-embed-format":e.format,"data-embed-profile":e.profile,"data-embed-naturalwidth":e.naturalwidth,"data-embed-naturalheight":e.naturalheight,"data-embed-thumb200width":0|e.thumb200width,"data-embed-thumb200height":0|e.thumb200height,"data-embed-author":t.author_name,"data-embed-provider":t.provider_name}),r&&i.addClass("writer-deviation-redraw"),a&&i.addClass("writer-deviation-film")),i||!1}function a(t,i){var r=e(t);return r?(i.url=t,i.id=r,d(i)):!1}function d(t){var e="http://www.deviantart.com/deviation/"+encodeURIComponent(t.id),a=$.Deferred();return i(e,t.cached).done(function(e){var i=r(e,t);i?a.resolve(i):a.reject()}).fail(function(t){a.reject(t)}),a}function n(t){return M(t.id).then(function(t){return $("<img>").attr({src:"http://s.deviantart.net/emoticons/"+t.src,width:t.w,height:t.h,alt:t.emoticon,"class":"writer-embed","data-embed-id":t.id,"data-embed-type":"emoticon"})})}function h(e,i,r){var d;if((!r||-1!=$.inArray("da:embed",r))&&(d=u(m(e))))return $.Deferred().resolve(d);if((!r||-1!=$.inArray("img",r))&&/\.(jpg|png|gif)$/i.test((t(e)||{}).pathname))return $.Deferred().resolve($("<img>",{src:e}));var n=$.Deferred();return(a(e,i)||$.Deferred().reject()).done(function(t){var e="da:"+(t.attr("data-embed-type")||"");r&&-1==$.inArray(e,r)?Writer.active.insert_thumbs&&(Writer.active.insert_thumb_format||"auto")==t.attr("data-embed-format")&&-1!=$.inArray("da:thumb",r)?n.resolve(t):n.reject():n.resolve(t)}).fail(function(){n.reject()}),n}function o(t){return"embed"==t.type?$.Deferred().resolve(u(t)):"emoticon"==t.type?"deviation"==t.profile?d(t):n(t):"upload"==t.type?void 0:d(t)}function m(e){function i(t){var e=t.href.match(/^http:\/\/backend\.deviantart\.(?:com|lan)\/embed\/film\/(\d+)\/1\/$/);return e?(e=e[1],{profile:"film",id:e,url:"http://backend.deviantart.com/embed/film/"+e+"/1/",width:638,height:360}):void 0}function r(t){var e=t.href.match(/^http:\/\/dreamup\.(?:com|lan)\/api\/commission-button\/(.+)$/);return e?(e=e[1],{profile:"dreamup-request",id:e,url:t.href,width:225,height:43}):void 0}function a(t){var e=t.href.match(/^http:\/\/sta\.(?:sh|nk)\/muro\/redraw\/embed\/(.+)$/);return e?(e=e[1],{profile:"redraw",id:e,url:"http://sta.sh/muro/redraw/embed/"+e,width:600,height:350}):void 0}function d(t){var e=null;return"youtu.be"==t.hostname?e=t.pathname.substr(1):/^(www\.)?youtube(-nocookie)?\.com$/.test(t.hostname)&&(e="/watch"==t.pathname?t.params.v:(t.pathname.match(/^\/embed\/([^\/]+)/)||[])[1]),e?{profile:"youtube",id:e,url:"http://youtube.com/watch?v="+e,width:560,height:315}:void 0}function n(t){var e=null;return"vimeo.com"==t.hostname||"www.vimeo.com"==t.hostname?e=t.pathname.substr(1):"player.vimeo.com"==t.hostname&&0===t.pathname.indexOf("/video/")&&(e=(t.pathname.match(/\/video\/(\d+)/)||[])[1]),e&&!/\D/.test(e)?{profile:"vimeo",id:e,url:"http://vimeo.com/"+e,width:500,height:281}:void 0}function h(t){var e=null;return"revision3.com"==t.hostname&&(e=(t.pathname.match(/^\/html5player-v(\d+)/)||[])[1]),e?{profile:"revision3",id:e,width:640,height:360}:void 0}function o(t){var e=null;return("ustream.tv"==t.hostname||"www.ustream.tv"==t.hostname)&&(e=(t.pathname.match(/\/(?:channel|embed)\/(\d+)/)||[])[1]),e?{profile:"ustream",id:e,width:480,height:296}:void 0}function m(t){var e=null;return"w.soundcloud.com"==t.hostname&&(e=((t.params.url||"").match(/api\.soundcloud\.com\/tracks\/(\d+)/)||[])[1]),e?{profile:"soundcloud",id:e,width:"100%",height:166}:void 0}e=$.trim(e);var u,l,s=$("<div>").append(e).children("iframe:first-child"),c={type:"embed"};return s.length?(u=s.attr("src"),c.width=s.attr("width"),c.height=s.attr("height")):(u=e,c.url=e),(u=t(u))?(l=d(u)||n(u)||h(u)||o(u)||a(u)||i(u)||r(u)||m(u),l?$.extend(l,c):!1):!1}function u(t){var e;if(!t)return!1;if("youtube"==t.profile)e="http://www.youtube.com/embed/"+t.id+"?wmode=opaque";else if("vimeo"==t.profile)e="http://player.vimeo.com/video/"+t.id;else if("film"==t.profile)e="http://backend.deviantart.com/embed/film/"+t.id+"/1/";else if("redraw"==t.profile)e="http://sta.sh/muro/redraw/embed/"+t.id;else if("revision3"==t.profile)e="http://revision3.com/player-v"+t.id;else if("ustream"==t.profile)e="http://www.ustream.tv/embed/"+t.id;else if("ooyala"==t.profile)e=t.id.length>=64?"http://st.deviantart.net/ooyala3.html?2#/"+t.width+"/"+t.height+"/"+t.id+"/":"http://player.ooyala.com/player.swf?embedCode="+t.id+"&version=2&keepEmbedCode=true";else if("dreamup-request"==t.profile)e="http://dreamup.com/api/commission-button/"+t.id;else{if("soundcloud"!=t.profile)return ddt.log("writer","Attempt to embed an unknown profile",t),!1;e="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/"+t.id+"&amp;color=ff5500&amp;auto_play=false&amp;show_artwork=true"}return $("<iframe>",{"class":"writer-embed never-hide-me",src:e,width:t.width,height:t.height,scrolling:"no",frameborder:"0","data-embed-type":"embed","data-embed-profile":t.profile,"data-embed-id":t.id,"data-embed-width":t.width,"data-embed-height":t.height,"data-embed-url":t.url,"data-embed-title":t.title,"data-embed-format":t.format})}function l(t){return $("<img>",{src:t.loadersrc||"//st.deviantart.net/minish/stash/writer/holder.png",id:"writer-embed-loader-"+($.now()+U++),"class":"writer-embed-loader",width:t.loaderwidth,height:t.loaderheight,"data-embed-type":t.type,"data-embed-profile":t.profile,"data-embed-id":t.id,"data-embed-width":t.width,"data-embed-height":t.height,"data-embed-format":t.format,"data-embed-cache":void 0===t.cached?!0:t.cached})}function s(t){if(/^(deviation|embed|emoticon|drawing)$/.test(t.type)){var e=/^(thumb|200H|bigthumb)$/.test(t.format);return"deviation"==t.type||"drawing"==t.type?e&&"drawing"!=t.type&&("200H"==t.format?t.type="thumb":(t.type=t.format,delete t.format)):delete t.format,$("<da:"+t.type+">").attr({profile:t.profile,id:t.id,width:e?null:t.width||null,height:e?null:t.height||null,format:t.format})}}function c(t){return{type:t.attr("data-embed-type"),profile:t.attr("data-embed-profile"),id:t.attr("data-embed-id"),width:t.attr("data-embed-width"),height:t.attr("data-embed-height"),url:t.attr("data-embed-url"),title:t.attr("data-embed-title"),format:t.attr("data-embed-format"),cached:t.attr("data-embed-cache"),author:t.attr("data-embed-author"),provider:t.attr("data-embed-provider")}}function f(t){var e={type:t[0].tagName.substr(3).toLowerCase(),profile:t.attr("profile"),id:t.attr("id"),width:t.attr("width"),height:t.attr("height"),format:t.attr("format")};return("thumb"==e.type||"bigthumb"==e.type)&&("200H"!=e.format&&(e.format=e.type),e.type="deviation"),e}function b(t){t.find(".writer-embed-loader").each(function(){var t=this.id,e=o(c($(this)));e&&e.done(function(e){if($("#"+t).replaceWith(e),e.is("img")){var i=new Image,r=5,a=e[0],d="//st.deviantart.net/minish/stash/stashing.gif",n=a.src;i.src=n,i.onload=function(){a.src=i.src},i.onerror=function(){r--?(a.src=d,setTimeout(function(){i.src=n+"?"+$.now()},2e3)):a.src="about:blank"}}PubSub.publish("WriterEmbed.loaded",e)}).fail(function(){$("#"+t).replaceWith(function(){return document.createTextNode(w(this.outerHTML))})})}),PubSub.publish("WriterEmbed.loading",t)}function p(t){return t.find("da\\:deviation, da\\:thumb, da\\:bigthumb, da\\:embed, da\\:emoticon, da\\:drawing").replaceWith(function(){return l(f($(this)))}),t}function w(t){return"string"==typeof t&&(t=$("<div></div>").html(t)),t.find(".writer-embed, .writer-embed-loader, iframe").replaceWith(function(){var t;return t=$(this).is("iframe")&&!$(this).closest(".writer-embed").length?s(m(this.outerHTML)):s(c($(this))),t||(t=$("<div></div>").text(this.outerHTML).html()),t}),t.html().replace(/<\/da:[^>]+>/gi,"")}function v(t){t.find("[data-embed-type]:not(.writer-embed)").replaceWith(function(){return s({type:$(this).attr("data-embed-type"),profile:$(this).attr("data-embed-profile"),id:$(this).attr("data-embed-id"),width:$(this).attr("data-embed-width"),height:$(this).attr("data-embed-height"),format:$(this).attr("data-embed-format")})}),t.find('a > img.avatar[alt^=":"]').unwrap().replaceWith(function(){return $(this).attr("alt")}),t.find('img[src^="http://e.deviantart."][alt]').replaceWith(function(){return $(this).attr("alt")})}function g(t,e){var i=+t.attr("data-embed-naturalwidth")||null,r=+t.attr("data-embed-naturalheight")||null,a="200H"==e.format?+t.attr("data-embed-thumb200width"):150,d="200H"==e.format?+t.attr("data-embed-thumb200height"):150;return t.is(".writer-deviation-film")?{resizeable:!1}:t.is(".writer-deviation-image, .writer-deviation-thumbnail")?{resizable:i>a||r>d,minSize:[a,d],maxSize:[i,r],aspectRatio:[i,r]}:t.is(".writer-deviation-iframe")?{resizable:!0,minSize:[a,d]}:y(t)?{resizable:!0,minSize:[150,150],maxSize:[t[0].naturalWidth,t[0].naturalHeight],aspectRatio:[t[0].naturalWidth,t[0].naturalHeight]}:{resizable:!1}}function y(t){return t.is("img:not(.writer-embed)")}function _(t){return t.is(".writer-deviation-thumbnail, .writer-deviation-lit-thumbnail")}function T(t){return t.is(".writer-deviation-image, .writer-deviation-iframe")||y(t)&&Math.max(t.width(),t.height())>150}function j(t){return t.is(".writer-deviation-thumbnail, .writer-deviation-lit-thumbnail")&&!t.is(".writer-deviation-redraw")||y(t)&&+t.attr("width")&&t[0].naturalWidth>+t.attr("width")}function z(t){return t.is(".writer-deviation-redraw")&&!t.is(".writer-deviation-image")}function W(t){return t.is(".writer-deviation-redraw")&&!t.is(".writer-deviation-iframe")}function k(t){if(!t.is(".writer-deviation-film")&&(t.is(".writer-deviation-thumbnail")||t.is(".writer-deviation-image"))){if(-1!==t.attr("src").indexOf("/minish/stash/stash-empty-item_120.png"))return!1;if(-1!==t.attr("src").indexOf("/minish/bears/empty-544.png"))return!1;if(Glbl("Site.is_stash")||Glbl("Site.is_stash_writer"))return!0;if("sta.sh"==t.attr("data-embed-provider"))return!0;if(window.deviantART.deviant.loggedIn&&window.deviantART.deviant.username==t.attr("data-embed-author"))return!0}return!1}function H(t){return!!c(t).url}function S(t,e){var i=+t[0].style.width.replace(/px/,"")||"",r=+t[0].style.height.replace(/px/,"")||"";if(y(t))return t.prop({width:i}),void 0;t.attr({"data-embed-width":i,"data-embed-height":r});var a="200H"==e.format?+t.attr("data-embed-thumb200width"):150,d="200H"==e.format?+t.attr("data-embed-thumb200height"):150;t.is(".writer-deviation-thumbnail")&&(t.width()>a||t.height()>d)?D(t):(t.is(".writer-deviation-image")||"bigthumb"==t.attr("data-embed-format"))&&a>=t.width()&&d>=t.height()&&A(t,e)}function x(t,e,i){if(y(e)){var r=e[0].naturalWidth,a=e[0].naturalHeight;if("thumb"==t){var n=150/Math.max(r,a);1>n&&e.attr("width",Math.round(r*n)).css({width:"",height:""})}else{if("auto"!=t)return;e.css({width:"",height:""}).removeAttr("width").removeAttr("height")}}return i=i||{},i.format||(i.format=t),d($.extend(c(e),i)).done(function(t){e.replaceWith(t)})}function A(t,e){return x("thumb",t,e)}function D(t){return x("auto",t)}function I(t){return x("redraw",t)}function C(t){return x("image",t)}function R(t){var e=c(t);e.url&&t.replaceWith($("<a>",{href:e.url,text:e.title||"[link]"}))}function L(){if(L.result&&"rejected"!=L.result.state())return L.result;var t=L.result=$.Deferred();return DiFi.pushPublicGet("Emoticons","getWriterList",[],function(e,i){e?t.resolve(i.response.content):t.reject()}),DiFi.send(),t}function M(t){var e=$.Deferred();if(M.cache){var i=M.cache[t];i?e.resolve(i):e.reject()}else L().done(function(i){var r=M.cache={};for(var a in i)r[i[a].id]=i[a];M.cache=r;var d=M.cache[t];d?e.resolve(d):e.reject()}).fail(function(){e.reject()});return e}function E(e){if(e=t(e),!e)return!1;var i=e.hostname.split(".").slice(-2).join(".");return $.inArray(i,["deviantart.com","deviantart.com","sta.sh","sta.sh","dreamup.com","dreamup.com","fav.me","youtube.com","youtube-nocookie.com","youtu.be","vimeo.com","revision3.com","ustream.tv","ooyala.com","soundcloud.com"])>=0}function F(t){var e=/^(id|class|contenteditable|src|width|height|scrolling|frameborder|data.+)$/i;t.find("*").add(t).each(function(){for(var t,i=this.style.width,r=this.style.height,a=this.style.backgroundImage,d=Array.prototype.slice.call(this.attributes),n=0;t=d[n];n++)e.test(t.name)||this.removeAttribute(t.name);this.src&&"IMG"!=this.tagName&&!E(this.src)&&$(this).remove(),i&&(this.style.width=i),r&&(this.style.height=r),a&&(this.style.backgroundImage=a)})}var G={},U=0;return{damlToLoaders:p,runLoaders:b,damlFromHtml:w,htmlFromLink:h,loaderFromAttrs:l,normalizeServerRenderedDaml:v,onResize:S,resizeMode:g,isThumbnail:_,isSwitchableToThumbnail:T,isSwitchableToFullSize:j,isSwitchableToRedraw:W,isSwitchableToImage:z,isSwitchableToLink:H,isEditableInMuro:k,switchToThumbnail:A,switchToFullSize:D,switchToRedraw:I,switchToImage:C,switchToLink:R,getEmoticons:L,isTrustedSource:E,sanitizeHtml:F}}(),window.DWait&&DWait.run("jms/lib/writer/embed.js");
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/Base.js","jms/lib/writer/writer.js","jms/lib/ddt.js"],function(){var t=Base.extend({constructor:function(){this.storage={},this.writerclass=Writer,this.default_options={separate_ident:!1}},get:function(t,e,s){var i,r;return this.options=$.extend({},this.default_options,s),t=this._id(t),ddt.log("writer","extracted id",t),this.storage[t]?this.storage[t]:(r=this.options.separate_ident?$("[ident="+t+"]"):$("#"+t),0===r.length?{success:!1,message:"Unable to locate textarea '#"+t+"'."}:(e.writerclass&&(this.writerclass=e.writerclass),i=new this.writerclass(t,r,e),this.storage[t]=i,i))},toggle:function(t,e,s){this.options=$.extend({},this.default_options,s);var i=this.get(this._id(t),e,s);return!i||i.success!==void 0&&!i.success||i.toggle(!0),i},destroy:function(t){t=this._id(t),this.storage[t]&&(this.storage[t].destroy(),delete this.storage[t])},destroyAll:function(){for(var t in this.storage)this.storage[t].destroy(),delete this.storage[t]},_id:function(t){if("string"!=typeof t){var e=$(t),s=e.attr("writer")||e.data("writer");if(e.length&&"TEXTAREA"==e[0].nodeName){var i=e[0];s||(s=i.getAttribute("id")),(!s||this.options.separate_ident)&&(s="writer"+Math.round(1e10*Math.random()),this.options.separate_ident?i.setAttribute("ident",s):i.setAttribute("id",s))}t=s}return t}});window.WriterFactory=new t,window.DWait&&DWait.run("jms/lib/writer/factory.js")});
DWait.ready(["jms/lib/browser.js","jms/lib/toolbar.js","jms/lib/popuptoolbar.js","jms/legacy/modals.js","jms/lib/popup2.js","jms/lib/jquery/plugins/jquery.throttle-debounce.js","jms/lib/jquery/plugins/jquery.transit.js"],function(){var e=window.WriterToolbarAction=PopupToolbarAction.extend({act:function(e){this.base(e),this.toolbar.updateStates(),this.isMenu||(Writer.active.$node.focus(),Popup2.hideAll())},enforceStates:function(){var e=this.toolbar.$node.data("states");for(var t in e)"blockquote"==t||e[t]!=document.queryCommandState(t)&&document.execCommand(t,!1,null)},enforceRichMode:function(){return Writer.active.enforceRichMode()},toggleState:function(e){if(this.enforceRichMode()){var t=this.toolbar.$node.data("states");t[e]=!t[e],this.toolbar.$node.data("states",t),Writer.active.beginEdit(),this.enforceStates(),Writer.active.endEdit(),this.toolbar.updateStates()}},destroy:$.noop}),t=window.WriterToolbarMenuAction=e.extend({constructor:function(e,t){this.base(e,t),this.popup_name=this.popup_name||"WriterPopup"+this.name},act:function(e){(!this.requires_rich_mode||this.enforceRichMode())&&this.base(e)},requires_rich_mode:!0,position_options:function(){var e=this.base();return e.bump.top+=2,e.bump.left-=5,e},isMenu:!0}),i={bold:e.extend({name:"bold",label:"B",title:"Bold",keyBind:66,act:function(){this.toggleState("bold")}}),italic:e.extend({name:"italic",label:"I",title:"Italic",keyBind:73,act:function(){this.toggleState("italic")}}),underline:e.extend({name:"underline",label:"U",title:"Underline",keyBind:85,act:function(){this.toggleState("underline")}}),ul:e.extend({name:"ul",label:"UL",title:"Unordered list",act:function(){this.enforceRichMode()&&(Writer.active.beginEdit(),document.execCommand("insertUnorderedList",!1,null),Writer.active.endEdit())}}),ol:e.extend({name:"ol",label:"OL",title:"Ordered list",act:function(){this.enforceRichMode()&&(Writer.active.beginEdit(),document.execCommand("insertOrderedList",!1,null),Writer.active.endEdit())}}),alignl:e.extend({name:"alignl",label:"Left Align",title:"Left Align",act:function(){this.enforceRichMode()&&Writer.active.align("left")}}),alignc:e.extend({name:"alignc",label:"Center Align",title:"Center Align",act:function(){this.enforceRichMode()&&Writer.active.align("center")}}),alignr:e.extend({name:"alignr",label:"Right Align",title:"Right Align",act:function(){this.enforceRichMode()&&Writer.active.align("right")}}),blockquote:e.extend({name:"blockquote",label:"Quote",title:"Quote",act:function(){this.enforceRichMode()&&Writer.active.toggleBlockquote()}}),undo:e.extend({name:"undo",label:"&#9100;",title:"Undo",act:function(){Writer.active&&Writer.active.undo&&Writer.active.inRichMode()?Writer.active.undo():document.execCommand("undo",!1,null)}}),redo:e.extend({name:"redo",label:"&#9100;",title:"Redo",act:function(){Writer.active&&Writer.active.redo&&Writer.active.inRichMode()?Writer.active.redo():document.execCommand("redo",!1,null)}}),link:e.extend({name:"link",label:"A",title:"Link",keyBind:107,act:function(e){if(this.enforceRichMode())if(e&&e.shiftKey)document.execCommand("unlink",!1,null);else{var t=prompt("Link:","");t&&document.execCommand("createLink",!1,t)}}}),headings:t.extend({name:"headings",label:"Headings",title:"Headings",noSwitching:!0,popup_options:{classes:"stashwriter-toolbar-menu",allow_class_override:!0,allow_parent_override:!0,content:'<div class="blockmenu"><li data-value="1" class="h1">H1 title</li><li data-value="2" class="h2">H2 subtitle</li><li data-value="3" class="h3">H3 header</li><li data-value="4" class="h4">H4 subheader</li><li data-value="5" class="h5">H5 smaller</li><li data-value="0">Normal</li></div>',events:[{selector:"li",event:"click",callback:function(){Writer.active.restore_selection(),Writer.active.setHeadingSize(+$(this).data("value"))}}]},position_options:function(){var e=this.base();return e.bump.top-=46,e.bump.left+=5,$("body").hasClass("ccwriter-subframe")&&($("body").hasClass("ccwriter-journal")?$("body").hasClass("stickhelper")?e.bump.top-=21:e.bump.top+=4:e.bump.top+=46),e}}),link2:t.extend({name:"link2",label:"Link",title:"Link",noSwitching:!0,popup_options:function(){return this._memoized_popup_options=this._memoized_popup_options||this._get_popup_options()},_get_popup_options:function(){return{classes:"stashwriter-toolbar-menu",allow_class_override:!0,allow_parent_override:!0,content:['<div class="blockmenu">','<form class="writer-subtoolbar-link-form">','<div style="margin-bottom:0.8em">',"<strong>URL</strong><br />",'<input type="text" class="text" name="url" placeholder="example.com"><br />','<label for="url" class="error">Did you provide a URL?</label>',"</div>",'<div style="margin-bottom:0.8em">',"<strong>Title (optional)</strong><br />",'<input type="text" class="text" name="title" placeholder="Enter link title" value=""><br />',"</div>",'<div style="margin-bottom:0.8em">','</div><input type="submit" class="smbutton smbutton-white" value="OK" style="height: 22px; min-width: 66px; margin: 2px 0 6px;">',"</form>","</div>"].join("\n"),hidden:function(e){this.default_popup_options().hidden.call(this,e),this.$node.parents(".commentwriter-toolbar").removeClass("overbearing")}.bindTo(this),shown:function(e){this.default_popup_options().shown.call(this,e),Writer.active.restore_selection();var t=Writer.active.get_selection(),i=Writer.active.get_selection_parent(t),o=t?t.toString?""+t:t.text:"",r="",a=$(i).closest("a");a.length&&(r=a.attr("href"),o=a.text()),e.$node.show(),e.$node.find("input[name=title]").val(o),e.$node.find('input[name="url"]').val(r).focus(),this.$node.parents(".commentwriter-toolbar").addClass("overbearing")}.bindTo(this),events:[{selector:"form",event:"submit",callback:function(e){e.preventDefault();var t=e.data.popup.$node,i=$.trim(t.find('input[name="url"]').val()),o=$.trim(t.find('input[name="title"]').val()),r=0===i.indexOf("<");if(!i)return t.find("label.error").show(),void 0;t.find("label.error").hide(),r||/^https?:\/\//i.test(i)||(i="http://"+i);var a=function(){Writer.active.addLink(i,o),Writer.active.sync(),Popup2.hideAll()};return setTimeout(function(){if(!r&&o)a();else{var e=WriterEmbed.htmlFromLink(i,{format:Writer.active.insert_thumbs?Writer.active.insert_thumb_format||"thumb":"auto"},Writer.active.options.valid_tags);e?(t.find("input:submit").val("Loading..."),e.done(function(e){Writer.active.insert(e),Popup2.hideAll()}).fail(function(){r?t.find("input:submit").val("OK"):a()})):a()}},0),!0}}]}},position_options:function(){var e=this.base();return e.bump.top-=46,e.bump.left+=5,$("body").hasClass("ccwriter-subframe")&&($("body").hasClass("ccwriter-journal")?$("body").hasClass("stickhelper")?e.bump.top-=21:e.bump.top+=4:e.bump.top+=46),e}}),edit:t.extend({name:"edit",label:"Edit",title:"Edit",requires_rich_mode:!1,popup_options:function(){return this._memoized_popup_options=this._memoized_popup_options||this._get_popup_options()},position_options:function(){var e=this.base();return $("body").hasClass("ccwriter-subframe")&&(e.bump.top-=1,e.bump.left+=5),e},_get_popup_options:function(){return{classes:$("body").hasClass("ccwriter-journal")||location.href.indexOf("/writer")>=0?"stashwriter-embed stashwriter-toolbar-menu with-icons":"writer-embed",allow_class_override:$("body").hasClass("ccwriter-journal"),allow_parent_override:$("body").hasClass("ccwriter-journal"),content:['<div class="blockmenu">','<li class="writer-toolbar-toggle-thumbsize"><i></i>Always Add Full Size Images</li>','<li class="writer-toolbar-switch-to-html"><i></i>Switch to HTML Mode</li>','<li class="writer-toolbar-switch-to-rich"><i></i>Switch to Rich Editing Mode</li>',"</div>"].join(""),shown:function(e){this.default_popup_options().shown.call(this,e),Writer.active.inRichMode()?(e.$node.find(".writer-toolbar-switch-to-rich").hide(),e.$node.find(".writer-toolbar-switch-to-html").show()):(e.$node.find(".writer-toolbar-switch-to-rich").show(),e.$node.find(".writer-toolbar-switch-to-html").hide())}.bindTo(this),created:function(){this.$node.find(".writer-toolbar-toggle-thumbsize")[Writer.active.insert_thumbs?"addClass":"removeClass"]("toggled-off")},events:[{selector:".writer-toolbar-switch-to-html, .writer-toolbar-switch-to-rich",event:"click",callback:function(){var e=Writer.active;e.inRichMode()?e.switchToHtmlMode():e.switchToRichMode()}},{selector:".writer-toolbar-toggle-thumbsize",event:"click",callback:function(){var e=$(this).hasClass("toggled-off");return $(this).toggleClass("toggled-off"),Writer.active.insert_thumbs=!e,setTimeout(function(){Writer.active.restore_selection(),Popup2.hideAll()},300),!0}}]}}}),secret:t.extend({name:"secret",label:"Secret",title:"Secret",secret_hit_count:0,render:function(e){return this.base(e).addClass("writer-toolbar-secret")},position_options:function(){var e=this.base();return $("body").hasClass("ccwriter-subframe")&&(e.bump.top-=1,e.bump.left+=5),e},act:function(e){if(!this.rendered)return!1;var t=$(e.target).closest(".writer-toolbar-secret"),i="1px solid #e4e4e4";switch(++this.secret_hit_count){case 1:t.css("border-top",i);break;case 2:t.css("border-right",i);break;case 3:t.css("border-bottom",i);break;case 4:t.css("border-left",i);break;case 5:t.removeClass("writer-toolbar-secret").css("border","").width(0).animate({width:58},150,function(){t.find("b").show()}).find("b").hide();break;default:this.base(e)}},requires_rich_mode:!1,popup_options:function(){return this._memoized_popup_options=this._memoized_popup_options||this._get_popup_options()},_get_popup_options:function(){return{classes:"stashwriter-embed stashwriter-toolbar-menu with-icons",allow_class_override:$("body").hasClass("ccwriter-journal"),allow_parent_override:$("body").hasClass("ccwriter-journal"),content:['<div class="blockmenu">','<li class="writer-toolbar-float-left"><i></i>Float Selection Left</li>','<li class="writer-toolbar-float-right"><i></i>Float Selection Right</li>','<li class="writer-toolbar-deformat"><i></i>Remove Formatting</li>','<li class="writer-toolbar-clear-all"><i></i>Clear Document</li>',"</div>"].join(""),hidden:function(e){this.default_popup_options().hidden.call(this,e),this.$node.parents(".commentwriter-toolbar").removeClass("overbearing")}.bindTo(this),shown:function(e){this.default_popup_options().shown.call(this,e),this.$node.parents(".commentwriter-toolbar").addClass("overbearing")}.bindTo(this),events:[{selector:".writer-toolbar-float-left",event:"click",callback:function(){Writer.active.floatSelection("left")}},{selector:".writer-toolbar-float-right",event:"click",callback:function(){Writer.active.floatSelection("right")}},{selector:".writer-toolbar-deformat",event:"click",callback:function(){Writer.active.restore_selection(),Writer.active.removeFormatting()}},{selector:".writer-toolbar-clear-all",event:"click",callback:function(){confirm("Are you sure you'd like to delete all the content of this document?")&&Writer.active.setContent("")}}]}}}),zoom:t.extend({name:"zoom",label:"100%",title:"Zoom",noSwitching:!0,popup_options:{classes:"stashwriter-toolbar-menu",allow_class_override:!0,allow_parent_override:!0,content:'<div class="blockmenu"><li data-value="1">100%</li><li data-value=".75">75%</li><li data-value=".5">50%</li><li data-value=".25">25%</li><li data-value=".1" class="last">10%</li></div>',events:[{selector:"li",event:"click",callback:function(){var e=$(this).data("value");e&&($(".stashwriter-subtoolbar div[class*=-zoom] span").text($(this).text()),Browser.isIE8?Writer.active.$node.closest(".writer-zoom-container").css("zoom",e):Writer.active.$node.closest(".writer-zoom-container").transition({transform:"scale("+e+")","transform-origin":"50% 0"}),Writer.active.restore_selection())}}]},position_options:function(){var e=this.base();return e.bump.top-=46,e.bump.left+=5,e}}),file:t.extend({name:"file",label:"File",title:"File",requires_rich_mode:!1,_errorMessage:null,_spinner:null,popup_options:function(){return this._memoized_popup_options=this._memoized_popup_options||this._get_popup_options()},position_options:function(){var e=this.base();return $("body").hasClass("ccwriter-subframe")&&(e.bump.top-=1,e.bump.left+=5),e},_get_popup_options:function(){return{classes:"stashwriter-file stashwriter-toolbar-menu with-icons",allow_class_override:$("body").hasClass("ccwriter-journal"),allow_parent_override:$("body").hasClass("ccwriter-journal"),content:['<ul class="blockmenu">','<li class="writer-toolbar-draft-autosave disabled">','<div class="writer-toolbar-draft-autosave-error"></div>','Last Autosave: <span class="writer-autosave-timestamp">never</span></li>','<li class="separator"></li>','<li class="writer-toolbar-draft-new"><i></i>New <span class="weak">Draft...</span></li>','<li class="writer-toolbar-draft-open-browse"><i></i>Open <span class="weak">Draft...</span></li>','<li class="writer-toolbar-draft-save"><i></i>Save <span class="weak">Draft</span></li>',"</ul>"].join(""),shown:function(e){this.default_popup_options().shown.call(this,e),this._popupOpen=!0,e.$node.find(".writer-autosave-timestamp").html(Writer.active.storage.last_save_string());var t=e.$node.find(".writer-toolbar-draft-autosave-error");this._errorMessage?(e.$node.addClass("error"),t.text(this._errorMessage).show()):(e.$node.removeClass("error"),t.empty().hide())}.bindTo(this),hidden:function(e){this.default_popup_options().hidden.call(this,e),this._popupOpen=!1,this.$node.toggleClass("error",!!this._errorMessage)}.bindTo(this),events:[{selector:".writer-toolbar-draft-new",event:"click",callback:function(){Writer.active.draft_handler.do_new()}},{selector:".writer-toolbar-draft-open-browse",event:"click",callback:function(){this.show_browse()}.bindTo(this)},{selector:".writer-toolbar-draft-save",event:"click",callback:function(){Writer.active.draft_handler.do_save(),Writer.active.restore_selection()}}]}},show_browse:function(){DWait.ready(["jms/pages/stash/stash.js"],function(){this._openDraftModal()}.bindTo(this))},_openDraftModal:function(){var e=this.modal=Modals.factory($('<div><div class="title"><h2>Open File</h2></div><div class="main"></div></div>'),{extraClassy:"loadDraftModal"});e.addButton("Close"),Modals.push(e,function(){PubSub.unsubscribe([{eventname:"Stash.item_open",subscriber:this},{eventname:"StashEmbedded.folder_loaded",subscriber:this},{eventname:"StashEmbedded.root_loaded",subscriber:this}]),PubSub.publish("WriterSidebar.start_stash",!0)}.bindTo(this)),e.getjQNode().on("click",".moveUp",function(e){e.preventDefault(),PubSub.publish("Stash.root_open")}),PubSub.subscribe([{eventname:"Stash.item_open",subscriber:this,callback:this._modalItemChosen.bindTo(this)},{eventname:"StashEmbedded.folder_loaded",subscriber:this,callback:this._modalFolderLoaded.bindTo(this)},{eventname:"StashEmbedded.root_loaded",subscriber:this,callback:this._modalRootLoaded}]),PubSub.publish("WriterSidebar.stop_stash"),Glbl("Stash.mode","plain|no_upload"),Glbl("Stash.filter","writer_drafts"),Glbl("Stash.browselimit",18),PubSub.publish("StashEmbedded.start"),DiFi.pushPost("Stashes","get_folder_id",["Drafts"],function(e,t){e&&t.response.content.size>1?PubSub.publish("Stash.folder_open",{id:t.response.content.id}):PubSub.publish("Stash.root_open")}),DiFi.send()},_modalFolderLoaded:function(e,t){var i=$(t),o=this.modal.getjQNode().find(".main");o.empty().append('<div class="navLink">&lt; <a href="#" class="moveUp">Sta.sh</a></div>'),i.find('.stash-tt-a[collect_rid!="1:0"]').length?i.appendTo(o):o.append('<h2 class="nofiles">You do not have any saved drafts.<h2>'),o.animate({scrollTop:0},"slow")},_modalRootLoaded:function(e,t){var i=$(t),o=this.modal.getjQNode().find(".main").empty();i.find('.stash-tt-a[collect_rid!="1:0"]').length?i.appendTo(o):o.append('<h2 class="nofiles">You do not have any saved drafts.<h2>'),o.animate({scrollTop:0},"slow")},_modalItemChosen:function(e,t){Modals.pop("cancel"),Writer.active.draft_handler.do_load(t.privateid)},setError:function(e){this._errorMessage=e,this._popupOpen||this.$node.addClass("error")},clearError:function(){this._errorMessage=null,this._popupOpen||this.$node.removeClass("error")},toggleProgress:function(e){e&&!this._spinner?(this.$node.addClass("autosaving"),this._spinner=new Spinner($.extend({},SpinnerPresets.green,{top:4,left:-2})),this._spinner.spin(this.$node.find("b")[0])):!e&&this._spinner&&(this.$node.removeClass("autosaving"),this._spinner.stop(),this._spinner=null)},destroy:function(){this.base(),this._spinner&&this._spinner.stop()}}),separator:e.extend({name:"separator",label:"",act:$.noop,render:function(){return this.$node=$('<div class="writer-toolbar-separator"></div>')}})};window.WriterToolbar=Toolbar.extend({actions:i,create:function(e,t){this.base(e,t),this.$toolbar.addClass("writer-toolbar"),this.$node.data("states",{bold:!1,italic:!1,underline:!1,blockquote:!1})},onKeyDown:function(e){this.base(e)},rebind:function(){var e=this.$toolbar.is(":visible")?150:1e3;this.$node.off("keydown.Toolbar").on("keydown.Toolbar",this.onKeyDown.bindTo(this)),this.$node.off("mouseup.toolbar").on("mouseup.toolbar",$.throttle(e,this.updateStates.bindTo(this))),this.$node.off("keyup.toolbar").on("keyup.toolbar",$.throttle(e,this.updateStates.bindTo(this)))},updateStates:function(){var e=Writer.active.get_selection();if(e){var t=e.commonAncestorContainer||e.parentElement();t&&3==t.nodeType&&(t=t.parentNode);var i=this.$node.data("states");i.bold=document.queryCommandState("bold"),i.italic=document.queryCommandState("italic"),i.underline=$(t).closest("a").length?!1:document.queryCommandState("underline"),i.blockquote=$(t).closest("blockquote").length>0;for(var o in i)this.$toolbar.find(".writersub-toolbar-"+o).toggleClass("active",i[o])}},destroy:function(){for(var e=0;this.toolbar.length>e;e++)this.toolbar[e].destroy();this.base()}}),window.DWait&&DWait.run("jms/lib/writer/toolbar.js")});
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/Base.js","jms/lib/popup2.js","jms/lib/dragger.js","jms/lib/spinpreset.js","jms/lib/pubsub.js"],function(){window.WriterImageControls=Base.extend({default_options:{attach_point:null,allowed_image_actions:["Draw","Image","Full","Thumb","Link","Remove"],image_actions_by_priority:["Remove","Thumb","Full","Link","Draw","Image"]},constructor:function(t,i){this.options=$.extend({},this.default_options,i),this.attach_point=this.options.attach_point||null,this.writer=t,this.$node=t.$node,this.attach(this.writer)},attach:function(t){var i=this;t!=this.writer&&(this.writer=t);var e=this.$node.parent();this.attach_point&&(e=this.$node.closest(this.attach_point));var s=$();this.resizer=new WriterImageControls.Resizer(this),s=s.add(this.resizer.$),this.menu=new WriterImageControls.MenuActionsOverlay(this,e),s=s.add(this.menu.$);var r=".writer-embed, .portfoliofile, .portfoliothumb, img";i.$node.on("keydown",function(){i.hide(!0)}).on("dragstart",function(){i.hide(!0)}).on("mouseover",r,function(){i.show(this)}).on("mouseout",r,function(){i.hide()}),s.off(".writerimagecontrols").on("mouseover.writerimagecontrols",function(){clearTimeout(i.hideTimer)}).on("mouseout.writerimagecontrols",function(){i.$current&&!i.resizer.resizing&&i.$current.trigger("mouseout")}),PubSub.subscribe({eventname:"WriterEmbed.loaded",subscriber:this,callback:this.embed_loaded})},show:function(t){t=$(t),this.resizer.resizing||t.is(".deleting")||"emoticon"==t.data("embed-type")||(clearTimeout(this.hideTimer),this.$current&&this.$current[0]==t[0]||(this.$current=t,this.resizer.show(t),this.menu.show(t)))},hide:function(t){this.$current&&(t?(clearTimeout(this.hideTimer),this.resizer.hide(),this.menu.hide(!0),this.$current=null):this.hideTimer=setTimeout(this.hide.bindTo(this,!0),500))},add_status:function(t,i,e){return this.clear_status(t),"error"===i?WriterImageControls.Status.set_error(this,t,e):"saving"===i?WriterImageControls.Status.set_saving(this,t):WriterImageControls.Status.set_loading(this,t)},clear_status:function(t){WriterImageControls.Status.clear(t)},embed_loaded:function(t,i){if(!this.$current){this.waiting_on_embed&&clearTimeout(this.waiting_on_embed);var e=i.is("img")?i:i.find("img");!e.length||void 0!==e[0].naturalWidth&&0!==e[0].naturalWidth||e[0].complete?(i.trigger("mouseover"),i.trigger("mouseout")):this.waiting_on_embed=setTimeout(bind(this,function(){this.embed_loaded(t,i)}))}}}),window.WriterImageControls.MenuActions=Base.extend({constructor:function(t,i){this.controls=t,this.$=this.create().appendTo(i)},show:function(t){this.$.css(this.position(t)).fadeIn()},hide:function(t){t?this.$.fadeOut("fast"):this.$.hide()},position:function(t){var i=t.position();return i.left=i.left+t.width()-this.$.width()-5,i.top=i.top+5,this.controls.attach_point&&(i.left-=this.controls.writer.$node.position().left,i.top-=this.controls.writer.$node.position().top),i},actions:{Remove:{label:"Remove",enabled:function(){return!0},act:function(t){t.addClass("deleting").slideUp("fast",function(){this.controls.writer.setFocusAfter(t[0]),this.controls.writer.beginEdit("delete_embed"),t.remove(),this.controls.writer.endEdit()}.bindTo(this))}},Draw:{label:"Edit in deviantART muro",enabled:function(t){return WriterEmbed.isEditableInMuro(t)},act:function(t){var i=t.attr("data-embed-id");if(i){var e,s,r,n,o=this,a=Glbl("Site.is_deviantart")?"http://muro.deviantart.com":"http://sta.sh/muro";Writer.active.frame(a+"/iframe?devid="+i,function(i,a){var h="remove";switch(i.action){case"error":return a.hidden&&o.controls.add_status(t,"error",function(){a.act("show")}),void 0;case"cancel":return o.controls.clear_status(t),"remove";case"got_id":return e=i.id&&parseInt(i.id,36),void 0;case"done":h="hide",i.img&&(r={src:i.img,width:i.image_width,height:i.image_height}),o.controls.add_status(t,"saving"),setTimeout(function(){e||o.controls.clear_status(t)},15e3);break;case"save":e=i.privateid||i.id,r={src:i.img,width:i.image_width,height:i.image_height},o.controls.clear_status(t);break;case"ready":var d=t.clone().css({position:"fixed","z-index":1001,top:t.offset().top-window.scrollY,left:t.offset().left-window.scrollX,width:t.get(0).clientWidth,height:t.get(0).clientHeight}).appendTo("body");return a.$.promise().done(function(){d.css({zoom:1}).animate({top:i.canvas_y,left:i.canvas_x,width:i.image_width*i.zoom,height:i.image_height*i.zoom},{duration:600,complete:function(){d.remove()}})}),"show";default:return}if(r)if(e){if(!s){var c=$("<img>",{src:r.src,"class":"writer-embed writer-deviation-redraw writer-deviation-"+("image"===t.attr("data-embed-format")?"image":"thumbnail"),"data-embed-id":e,"data-embed-type":"drawing","data-embed-format":t.attr("embedformat")||"image","data-embed-naturalwidth":t.attr("data-embed-naturalwidth"),"data-embed-naturalheight":t.attr("data-embed-naturalwidth")});t.attr("data-embed-width")&&c.attr("data-embed-width",t.attr("data-embed-width")).width(t.attr("data-embed-width")),"thumb"===t.attr("data-embed-format")&&c.css("max-width","150px").css("max-height","150px"),c.data("writer-imagecontrol-status",t.data("writer-imagecontrol-status")),o.controls.writer.beginEdit("edit_in_muro"),t.replaceWith(c),o.controls.writer.endEdit(),WriterEmbed.runLoaders(Writer.active.$node),t=c,s=!0,n&&Writer.active.markAsDoneSaving()}}else t.attr({src:r.src}),n||(Writer.active.markAsSaving(),n=!0);return h}),this.controls.add_status(t)}}},Thumb:{label:"Switch to Thumb",enabled:function(t){return WriterEmbed.isSwitchableToThumbnail(t)},act:function(t){var i=t;if(this.controls.writer.beginEdit("switch_to_thumb"),i.is(".portfoliofile")){var e,s,r=i.width(),n=i.height();r>=n?(e=150,s=n/r*e):(s=150,e=r/n*s),i.width(e).height(s).removeClass("portfoliofile").addClass("portfoliothumb")}else WriterEmbed.switchToThumbnail(i,{format:this.controls.writer.insert_thumbs?this.controls.writer.insert_thumb_format||"auto":null});this.controls.writer.endEdit()}},Full:{html:"Full size",label:"Switch to Full Size",enabled:function(t){return WriterEmbed.isSwitchableToFullSize(t)},act:function(t){var i=t;this.controls.writer.beginEdit("switch_to_fullsize"),i.is(".portfoliothumb")?i.removeAttr("width").removeAttr("height").removeClass("portfoliothumb").addClass("portfoliofile").css({width:"",height:""}):WriterEmbed.switchToFullSize(i),this.controls.writer.endEdit()}},Link:{label:"Switch to Link",enabled:function(t){return WriterEmbed.isSwitchableToLink(t)},act:function(t){this.controls.writer.beginEdit("switch_to_link"),WriterEmbed.switchToLink(t),this.controls.writer.endEdit()}},Redraw:{label:"Switch to muro Redraw",enabled:function(t){return WriterEmbed.isSwitchableToRedraw(t)},act:function(t){this.controls.writer.beginEdit("switch_to_redraw"),WriterEmbed.switchToRedraw(t),this.controls.writer.endEdit()}},Image:{label:"Switch to Image",enabled:function(t){return WriterEmbed.isSwitchableToImage(t)},act:function(t){this.controls.writer.beginEdit("switch_to_image"),WriterEmbed.switchToImage(t),this.controls.writer.endEdit()}},Test:{label:"Developer status test",enabled:function(){return ddt.watching("writer")},act:function(t){t.data("writer-imagecontrol-status")?this.controls.clear_status(t):this.controls.add_status(t)}}}}),window.WriterImageControls.MenuActionsOverlay=window.WriterImageControls.MenuActions.extend({create:function(){for(var t=this,i=$('<div class="writer-imagemenu"></div>').hide().on("click",".action",function(i){i.preventDefault(),i.stopPropagation();var e=$(this).data("action");t.actions[e]&&t.actions[e].act.call(t,t.controls.$current)!==!1&&t.controls.hide(!0)}),e=this.controls.options.allowed_image_actions,s=0;e.length>s;s++){var r=t.actions[e[s]];$('<div class="action action-with-label">').html(r.html||e[s]).attr("data-action",e[s]).prop("title",r.label).prepend("<i></i>").appendTo(i)}return $('<div class="action tiny-remove">').attr("data-action","Remove").appendTo(i),i},show:function(t){var i=this,e=82,s=30,r=t.width(),n=t.height(),o=i.controls.options.allowed_image_actions,a=i.controls.options.image_actions_by_priority,h=a.filter(function(e){return $.inArray(e,o)>=0&&i.actions[e].enabled(t)}),d=$.inArray("Remove",h)>=0;h=h.slice(0,n/s),h.length&&r>=e?(i.$.find(".tiny-remove").hide(),i.$.find(".action-with-label").each(function(t,i){var e=$(i).data("action");$(i).toggle($.inArray(e,h)>=0)}),this.base(t)):d&&(i.$.find(".action-with-label").hide(),i.$.find(".tiny-remove").show(),this.base(t))}}),window.WriterImageControls.Resizer=Base.extend({constructor:function(t){this.image_controls=t,this.resizing=!1,this.min_size=[1,1],this.max_size=[1/0,1/0],this.aspect_ratio=null,this._$element=null,this.$=this._create_handles(),this._bind_events()},show:function(t){this.image_controls.$node[0].oncontrolselect=function(){return!1};try{document.execCommand("enableObjectResizing",!1,!1)}catch(i){}if(!this.image_controls.options.prevent_resize){t=$(t);var e=WriterEmbed.resizeMode(t,{format:this.image_controls.writer.insert_thumbs?this.image_controls.writer.insert_thumb_format||"auto":null});this.resizing||!e.resizable&&!t.is(".portfoliofile")||(this._$element=t,this.min_size=e.minSize,this.max_size=e.maxSize,this.aspect_ratio=e.aspectRatio,this.$.appendTo(this.image_controls.$node.parent()),this._update_size())}},hide:function(){this.resizing||this.$.detach()},on_start:function(){this.image_controls.menu.hide(),this.image_controls.writer.beginEdit("resize_element")},on_stop:function(){WriterEmbed.onResize(this._$element,{format:this.image_controls.writer.insert_thumbs?this.image_controls.writer.insert_thumb_format||"auto":null}),this.image_controls.writer.endEdit()},_update_size:function(t){t&&this._$element.css({width:t.width,height:"IMG"==this._$element[0].tagName?"auto":t.height});var i=this._$element.position(),e=this._$element.width(),s=this._$element.height(),r=this;this.$.each(function(t){var n={left:i.left+(1&t?e:0),top:i.top+(2&t?s:0)};r.image_controls.attach_point&&(n.left-=r.image_controls.writer.$node.position().left,n.top-=r.image_controls.writer.$node.position().top),$(this).css(n)})},_create_handles:function(){return $('<div class="writer-resize-handle nw" /><div class="writer-resize-handle ne" /><div class="writer-resize-handle sw" /><div class="writer-resize-handle se" />')},_bind_events:function(){var t,i,e,s,r,n=this;new Dragger(n.$,n.image_controls.$node.parent(),function(o,a,h){n.resizing=!0,t=$.inArray(h,n.$),i=n._$element.width(),e=n._$element.height(),s=o[0],r=o[1],n.on_start()},function(o){n._update_size(n._constrain_size({width:i+(1&t?1:-1)*(o[0]-s),height:e+(2&t?1:-1)*(o[1]-r)}))},function(){n.resizing=!1,n.hide(),n.on_stop()})},_constrain_size:function(t){var i=t.width,e=t.height,s=this.min_size&&this.min_size[0]||1,r=this.min_size&&this.min_size[1]||1,n=this.max_size&&this.max_size[0]||1/0,o=this.max_size&&this.max_size[1]||1/0;if(this.aspect_ratio){var a=this.aspect_ratio[0],h=this.aspect_ratio[1],d=(i*h-e*a)/(h*h+a*a);i-=d*h,e+=d*a,(i>n||e>o)&&(i=a*Math.min(n/a,o/h),e=h*Math.min(n/a,o/h)),s>i&&r>e&&(i=a*Math.min(s/a,r/h,1),e=h*Math.min(s/a,r/h,1))}else i=Math.min(i,n),e=Math.min(e,o),i=Math.max(i,s),e=Math.max(e,r);return{width:Math.round(i),height:Math.round(e)}}}),window.WriterImageControls.Status=Base.extend({constructor:function(){this.spinner=new Spinner($.extend({},SpinnerPresets.green,{top:-13,left:-7})),this.$status=$('<div class="writer_imagestatus"><div class="message"></div></div>')},attach:function(t,i,e,s){var r=i.position();this.$status.appendTo(t.$node.parent()).css({left:r.left,top:r.top,width:i.width(),height:i.height()});var n=this.$status.find(".message").html(e);n.css({left:(i.width()-n[0].offsetWidth)/2,top:(i.height()-n[0].offsetHeight)/2}),s&&n.click(s),i.data("writer-imagecontrol-status",this),this.spinner.spin(this.$status.find(".positive")[0])},detach:function(t){this.$status.remove(),t.removeData("writer-imagecontrol-status")}},{_stack:[],set:function(t,i,e){var s=WriterImageControls.Status._stack.pop();s||(s=new WriterImageControls.Status),s.attach(t,i,e)},clear:function(t){var i=t.data("writer-imagecontrol-status");i&&(i.detach(t),WriterImageControls.Status._stack.push(i))},set_loading:function(t,i){WriterImageControls.Status.set(t,i,'&nbsp;<span class="positive"></span>&nbsp;&nbsp; Loading...')},set_saving:function(t,i){WriterImageControls.Status.set(t,i,'&nbsp;<span class="positive"></span>&nbsp;&nbsp; Saving...')},set_error:function(t,i,e){WriterImageControls.Status.set(t,i,'<span class="negative">Error</span> - Click Here for Details',e)}}),window.DWait&&DWait.run("jms/lib/writer/imagecontrols.js")});
DWait.ready(["jms/lib/Base.js","jms/lib/popup2.js","jms/lib/carotid.js","jms/lib/php.js"],function(){window.LinkEditor=Base.extend({constructor:function(i){this.$node=$(i).off(".linkeditor").on("keyup.linkeditor paste.linkeditor writereditcomplete.linkeditor click.linkeditor",bind(this,this.caret_check)),this.popup=new Popup2("writer-link-editor","body",{content:$("<i></i><span>URL</span><br><input>"),classes:"writer-link-editor",hidden:bind(this,function(){if(this.$link){var i=this.popup.$node.find("input").val();if(i){if(/^https?:\/\//i.test(i)||(i="http://"+i),i==this.$link.attr("href"))return;this.$link.attr("href",i).toggleClass("external",!PHP.isSafeURL(i))}else this.$link.replaceWith(function(){return this.innerHTML});this.$node.trigger("change")}})})},show:function(i){this.$link=$(i),this.popup.show(this.popup.position(this.$link)),this.popup.$node.find("input").val(this.$link.attr("href")),this.popup.$node.off(".linkeditor").on("keydown.linkeditor","input",bind(this,this.popup_keydown))},hide:function(){this.isShown()&&this.popup.hide()},isShown:function(){return this.popup.visible()},caret_check:function(){var i=Carotid.getNode(this.$node[0]),t=$(i).closest("a");t.length?this.show(t):this.hide()},popup_keydown:function(i){switch(i.which){case 13:case 27:this.hide()}}}),window.DWait&&DWait.run("jms/lib/writer/linkeditor.js")});
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/Base.js","jms/lib/browser.js","cssms/lib/writer.css","jms/lib/writer/embed.js","jms/lib/writer/toolbar.js","jms/lib/writer/imagecontrols.js","jms/lib/writer/undo.js","jms/pages/stash/stash.embedded.js","jms/pages/stash/stash.uploader.js","jms/lib/pubsub.js","jms/lib/jquery/ui/jquery.ui.droppable.js","jms/lib/php.js","jms/lib/jquery/plugins/jquery.scrollto.js","jms/lib/autocomplete.js","jms/lib/popup2.js"],function(){(function(t){var e=function(t){if(t.outerHTML)return t.outerHTML;var e,i=document.createElement("div");return i.appendChild(t.cloneNode(!0)),e=i.innerHTML,i=null,e},i=function(e){var i;do i=e,e=e.replace(/\s(onerror|onload|onunload)\s*?=/gi," ");while(e!=i);return t.parseHTML(e)},n=function(t,e){if(document.selection){t.focus();var i=document.selection.createRange();i.text=e,t.focus()}else if(void 0!==t.selectionStart){var n=t.selectionStart,o=t.selectionEnd,s=t.scrollTop;t.value=t.value.substring(0,n)+e+t.value.substring(o,t.value.length),t.focus(),t.selectionStart=t.selectionEnd=n+e.length,t.scrollTop=s}else t.value+=e,t.focus()},o=function(e){return!/\S/.test(t(e).text())&&!t(e).find("img, iframe").length},s=function(){if(!window.getSelection)return!1;var e=window.getSelection();if(!e.rangeCount)return!1;var i=e.getRangeAt(0),n=t(i.startContainer).closest("blockquote");if(!n.length)return!1;i.deleteContents(),i.setEndAfter(n[0]);var s=i.extractContents();s.normalize();for(var r=s;r=r.firstChild;)if(r.tagName&&"IMG"!=r.tagName&&!r.textContent){var a=r.nextSibling;a&&"BR"==a.tagName&&t(a).remove(),t(r).remove();break}o(s)||n.after(s);var h=t("<div>&nbsp;</div>");return n.after(h),o(n[0])&&n.remove(),i.selectNodeContents(h[0]),i.collapse(!0),e.removeAllRanges(),e.addRange(i),!0},r=function(){if(window.getSelection){var t=window.getSelection();t.rangeCount>0&&(range=t.getRangeAt(0),t.removeAllRanges(),t.addRange(range))}},a=function(){if(!window.getSelection)return!1;var t=document.getSelection();if(!t.rangeCount)return!1;for(var e=t.getRangeAt(0),i=e.startContainer,n=!e.startOffset;i&&n;){if("LI"==i.tagName)return!0;var o=i.parentNode;n=o&&o.firstChild==i,i=o}return!1},h=function(t,e){var i=e,n=i.which;if(!(i.altKey||i.shiftKey||i.ctrlKey||i.metaKey))if(!Browser.isGecko||37!=n&&39!=n)if(!Browser.isKHTML||33!=n&&34!=n){if(Browser.isKHTML&&(37==n||39==n)){var o=getSelection();if(o.isCollapsed&&o.rangeCount){var s=o.getRangeAt(0);o.modify("extend",37==n?"left":"right","character"),o.isCollapsed&&i.preventDefault(),o.removeAllRanges(),o.addRange(s)}}}else{for(var r=[];t=t.parentElement;)r.push(t.scrollLeft,t);setTimeout(function(){for(;r.length;)r.pop().scrollLeft=r.pop()},0)}else getSelection().modify("move",37==n?"left":"right","character"),i.preventDefault()},d=Base.extend({default_options:{valid_tags:["[a-zA-Z:]+"],valid_attrs:["[a-zA-Z:]+"]},constructor:function(e,i){this.writer=e,this.options=t.extend({},this.default_options,i)},sync:function(t){var e;if(t){if(e=this.textarea_value(),this.writer.storage.is_dirty(e))return this.set_writer_value(this.to_html(e)),!0}else if(e=this.from_html(this.writer_value()),this.writer.storage.is_dirty(e))return this.set_textarea_value(e),!0},textarea_value:function(){return this.writer.$textarea.val()},set_textarea_value:function(t){this.writer.$textarea.val(t).change()},writer_value:function(){return this.writer.$node.html()},set_writer_value:function(t){this.writer.$node.html(t),WriterEmbed.runLoaders(this.writer.$node)},to_html:function(n){ddt.log("writerverbose","to_html passed",n),n=n.replace(/\n/g,"<br />"),n=n.replace(/<da:(deviation|thumb|bigthumb|embed|emoticon|drawing|widget) ([^>]+)>/gi,function(t,e){return t+"</da:"+e+">"});var o=t("<div>").html(i(n));o.find("style, script, textarea, .thumb-attachment, .thumb-attachment-content").remove(),o.find("da\\:widget").attr("wytiwyg",1);for(var s=o.find("[wytiwyg]");s.length>0;){var r=s.eq(0),a=e(r.clone().removeAttr("wytiwyg").empty()[0]),h=RegExp("</"+r[0].tagName+">$","i"),d=a.match(h);a=a.replace(h,""),d&&!r[0].tagName.match(/^da:/i)&&r.after(document.createTextNode(d[0])),r.before(document.createTextNode(a)),r.replaceWith(r.html()||document.createTextNode("")),s=o.find("[wytiwyg]")}var l=this.options.valid_tags,c=this;return o.find("*").each(function(){if(-1==t.inArray(this.nodeName.toLowerCase(),l)){try{t(this).contents().unwrap()}catch(e){}t(this).remove()}else 0===this.tagName.indexOf("DA:")||c.sanitize_attributes(this)}),o.find("a").each(function(){t(this).toggleClass("external",!PHP.isSafeURL(this.getAttribute("href")))}),ddt.log("writerverbose","to_html produced",o.html()),WriterEmbed.damlToLoaders(o).html()},from_html:function(e){function n(){return"<"+arguments[1].toLowerCase()+arguments[2]+">"}function o(){return attributes=arguments[2],attributes=attributes.replace(/(.+)=([^"].+[^"])\s+/gi,'$1="$2" '),attributes=attributes.replace(/\s+(.+)=([^"].+[^"])/gi,' $1="$2"'),"<"+arguments[1].toLowerCase()+" "+attributes+">"}ddt.log("writerverbose","from_html passed",e);var s=this,r=t("<div>").html(i(e)),a=function(){var e=t(this);switch(this.nodeType){case 8:e.remove();break;case 3:/^<iframe[^>]*><\/iframe>/.test(this.nodeValue)?e.replaceWith(i(this.nodeValue)):this.nodeValue=this.nodeValue.replace(/(http:\/\/[^\s<"]+)\u00A0/gi,"$1 ");break;case 1:if(!e.is(".writer-embed, .writer-embed-loader")&&(s.sanitize_attributes(this),!e.is("embed, frame, iframe, object"))){var n=e.contents();n.length&&n.each(a)}}};r.contents().each(a),r.find("a").removeClass("external").filter('[class=""]').removeAttr("class"),e=WriterEmbed.damlFromHtml(r),Browser.isGecko&&(e=e.replace(/<(img|input|area|br|hr)\s(.*)\B>/gim,"<$1 $2 />"),e=e.replace(/<(img|input|area|br|hr)(\s*)>/gim,"<$1 />"),e=e.replace(/<\/(img|input)>/gim,"")),Browser.isIE&&!Browser.isIE11&&(e=e.replace(/<(\/?\w+)(\s*[^>]*)>/gim,n),e=e.replace(/<(img|input|area|br|hr)\s(.*)\B>/gim,"<$1 $2 />"),e=e.replace(/<(img|input|area|br|hr)(\s*)>/gim,"<$1 />"),e=e.replace(/<\/(img|input)>/gim,""),e=e.replace(/<(\/?\w+)\s+([^>]*)>/gim,o),e=e.replace(/<li>/gim,"</li>\n<li>"),e=e.replace(/(<ul>(\s*)<\/li>)/gim,"<ul>"),e=e.replace(/(<\/li>(\s*)<\/li>)/gim,"</li>")),e=e.replace(/<span class="dautocomplete_space">&nbsp;(.*?)<\/span>/gi," $1"),e=e.replace(/<\/da:(?:deviation|embed|thumb|emoticon|drawing|widget)>/gi,""),e=e.replace(/<\?xml[^>+]>/gi,""),e=e.replace(/<br ?\/?>/g,"\n");var h="("+this.options.valid_tags.join("|")+")";return e=e.replace(RegExp("&lt;(/?)"+h+"([\\s/].*?)?"+"&gt;","gi"),function(e,i,n,o){return i?"</"+n+">":(o=t("<div/>").html(o).text(),"<"+n+' wytiwyg="1"'+o+">")}),e=t.trim(e),ddt.log("writerverbose","from_html produced",e),e},sanitize_attributes:function(t){if(t.attributes.length)for(var e,i=RegExp("^(?:"+this.options.valid_attrs.join("|")+")$","i"),n=0;e=t.attributes.item(n);n++)i.test(e.name)||(t.removeAttribute(e.name),n--)}}),l=Base.extend({constructor:function(e,i){this.title_callback=e,this.metadata_callback=i,this.onSaveStart=t.Callbacks(),this.onSaveEnd=t.Callbacks(),this.empty_hash=this.hash=this.saved_hash=this._hash("",!0),this.is_saving=!1,this.last_save=!1},id:function(t){return t?this.privateid:this.deviation_id},save:function(t,e,i){if(window.deviantART.deviant.id&&!this.is_saving&&!this.is_loading){t=this._process_saved_value(t);var n=this._hash(t);if(n!==this.saved_hash)return this.hash=n,this.is_empty()?(this.id()&&this.remove(),i&&e(),void 0):(this.is_saving=!0,this._save(t,e))}},_save:function(t,e){return this.deviation_id?DiFi.pushPost("Stash","update_journal",[this.deviation_id,this.deviation_version,this.title_callback(),t,this.metadata_callback()],bind(this,this._save_done,e)):DiFi.pushPost("Stash","create_journal",[deviantART.deviant.id,this.title_callback(),t,-1,this.metadata_callback()],bind(this,this._save_done,e)),this.onSaveStart.fire(),DiFi.send(),!0},_save_done:function(e,i,n){this.is_saving=!1,i&&(this.deviation_id=n.response.content.stashid,this.deviation_version=n.response.content.version,this.privateid=n.response.content.privateid,this.last_save=t.now(),this.saved_hash=this.hash,e(n.response.content)),this.onSaveEnd.fire(i,n.response)},save_synchronous:function(t,e){var i=DiFi._async;DiFi._async=!1,this.save(t,e),DiFi._async=i},load:function(t,e){this.is_loading=!0,DiFi.pushPost("Deviation","GetOriginalText",[t],bind(this,this._load_done,e)),DiFi.send()},_load_done:function(t,e,i){if(this.is_loading=!1,!e)return this.remove();var n=i.response.content;n.stash&&(this.deviation_version=n.version,this.deviation_id=n.id,this.privateid=n.privateid),this._set_content(n,t)},_set_content:function(t,e){t=this._process_loaded_content(t,e),e.setInitialText(t.text),e.options.on_load_content(t),e.save_requested_after_loading&&(e.save_requested_after_loading=!1,e.saveContent()),this.hash=this.saved_hash=this._hash(t.text)},remove:function(t,e){if(this.deviation_id&&t){var i=DiFi._async;DiFi._async=!1,DiFi.pushPost("Deviation","DeleteSingle",[this.deviation_id,5],e),DiFi.send(),DiFi._async=i}this.clear()},clear:function(){this.deviation_id=!1,this.deviation_version=!1,this.privateid=!1,this.hash=this.saved_hash=this.empty_hash},is_empty:function(){return this.hash==this.empty_hash},is_dirty:function(t){return this.saved_hash!=this._hash(t)},_hash:function(e,i){return e=t.trim(e)+"title:"+t.trim(this.title_callback()||""),t.each(this.metadata_callback()||{},function(t,n){e+=i?t+":":t+":"+(n||"")}),e},_process_saved_value:function(t){return t},_process_loaded_content:function(t){return t},last_save_string:function(){if(!this.last_save)return"never";var t=new Date(this.last_save),e=t.getHours(),i=e>=12?"pm":"am",n=t.getMinutes();return e>12?e-=12:1>e&&(e+=12),10>n&&(n="0"+n),e+":"+n+i}}),c=l.extend({_save:function(t,e){setTimeout(bind(this,function(){this._save_done(e,!0,{response:{content:{stashid:!1,privateid:!1,version:0,is_stash:!1,url:"",short_url:""}}})}),1)},is_dirty:function(){return!0}});window.DeviationWriterStatusNotifier=Base.extend({getFileMenu:t.noop,getTitle:t.noop,forceAlert:!1,invalidTitle:null,constructor:function(e){this.onSaveStart=t.proxy(this,"onSaveStart"),this.onSaveEnd=t.proxy(this,"onSaveEnd"),this.storage=e,e.onSaveStart.add(this.onSaveStart),e.onSaveEnd.add(this.onSaveEnd)},destroy:function(){var t=this.getFileMenu();t&&(t.clearError(),t.toggleProgress(!1)),this.storage.onSaveStart.remove(this.onSaveStart),this.storage.onSaveEnd.remove(this.onSaveEnd)},onSaveStart:function(){var t=this.getFileMenu();t&&t.toggleProgress(!0)},onSaveEnd:function(t,e){var i=this.getFileMenu(),n=this.getTitle();if(i&&i.toggleProgress(!1),t)i&&i.clearError(),e.content.title_error?n!=this.invalidTitle&&(this.invalidTitle=n,DiFi.stdErr(null,e.content.title_error)):this.invalidTitle=null;else{var o=this.menuMessageFromDiFiResponse(e);o&&i&&!this.forceAlert?i.setError(o):DiFi.stdErr(null,e.content)}},menuMessageFromDiFiResponse:function(t){var e=t.content.error.code;return"ERR_INVALID_RESPONSE"==e?"No Internet Connection":"ERR_DIFI_ACCESS_DENIED"==e?"Not Logged In":"ERR_TEXT_MAX_SIZE_EXCEEDED"==e?"Document is Too Large to Save":"ERR_UNAUTHORIZED"==e?"Editing Privileges Lost":void 0}});var u=window.Writer=Base.extend({default_options:{on_load_content:t.noop,on_save_content:t.noop,on_remove_content:t.noop,on_switch_editing_mode:t.noop,content:!1,draft_handler:"DraftHandler",draft_id_override:!1,draft_metadata:function(){return{}},draft_title:function(){return"Draft"},syncer:d,sync_timeout:2e3,storage:l,valid_tags:["br","hr","strong","b","code","sub","sup","small","tt","acronym","a","abbr","strike","em","i","u","ins","span","blockquote","p","bcode","ul","ol","dl","pre","li","cut","div","da:embed","da:deviation","da:thumb","da:bigthumb","da:widget","da:emoticon","da:drawing","img","font","table","tbody","tr","td","h1","h2","h3","h4","h5","h6"],valid_attrs:["align","alt","class","height","href","name","skinscript","src","title","width","target"],allow_html_mode:!0,passthrough_tab:!1,block_sidescroll:!1,imagecontrol_options:null,stash_upload:!0,autocomplete_priority:!1,call_on_save_if_empty:!1},constructor:function(e,i,n){this.options=t.extend({},this.default_options,n),this.id=e+"-writer",this.editingMode="rich",this.create(i),"string"==typeof this.options.syncer&&(this.options.syncer=u[this.options.syncer]),this.syncer="function"==typeof this.options.syncer?new this.options.syncer(this,{valid_tags:this.options.valid_tags,valid_attrs:this.options.valid_attrs}):this.options.syncer,"string"==typeof this.options.storage&&(this.options.storage=u[this.options.storage]),this.storage="function"==typeof this.options.storage?new this.options.storage(this.options.draft_title,this.options.draft_metadata):this.options.storage,"string"==typeof this.options.draft_handler&&(this.options.draft_handler=u[this.options.draft_handler]),this.draft_handler="function"==typeof this.options.draft_handler?new this.options.draft_handler(this):this.options.draft_handler,this.save_actions=[],this.history=new WriterUndo(this),this.attach(i),i.attr("writer",e),u.active=this},toString:function(){return"[Writer "+this.id+"]"},isSaving:function(){return this.storage.is_saving||this.sync_queued||this.save_override},markAsSaving:function(){this.save_override=(this.save_override||0)+1},markAsDoneSaving:function(){this.save_override=Math.max((this.save_override||0)-1,0),this.runSaveCallbacks()},whenSaved:function(t){this.isSaving()?this.save_actions.push(t):t(this)},runSaveCallbacks:function(){if(this.isSaving())return ddt.log("writer","tried to run save callbacks while saving"),void 0;for(var t;t=this.save_actions.pop();)t(this)},isDirty:function(){return this.storage.is_dirty(this.getContent())},getContent:function(t){return t&&this.sync(),this.$textarea.val()},getHTMLContent:function(){return this.$node.html()},setContent:function(t){console.log("setContent",t),this.$node.html(t),this.sync()},setInitialText:function(t){console.log("setting text",t),this.syncer.set_textarea_value(t),this.syncer.sync(!0)},setText:function(t){this.setInitialText(t),this.saveContent()},saveContent:function(){return this.storage.is_loading?(this.save_requested_after_loading=!0,void 0):this.storage.save(this.getContent(),bind(this,this.savedContent),this.options.call_on_save_if_empty)},savedContent:function(t){this.options.on_save_content(t),this.runSaveCallbacks()},removeSavedContent:function(t){this.storage.remove(t,bind(this,this.options.on_remove_content))},loadContent:function(t){this.storage.load(t,this)},clearDefault:function(){this.update_placeholder(),this.$node.hasClass("empty")&&this.is_empty()&&(this.getContent()&&this.setContent(""),this.$node.removeClass("empty"))},onPasteFinished:function(){var e,i=this.options.valid_tags,n=this.syncer;if(this.$node.find("style, script, textarea, .thumb-attachment, .thumb-attachment-content").remove(),WriterEmbed.normalizeServerRenderedDaml(this.$node),this.$node.find(".writer-embed, .writer-embed-loader").each(function(){WriterEmbed.sanitizeHtml(t(this))}),WriterEmbed.damlToLoaders(this.$node),WriterEmbed.runLoaders(this.$node),this.$node.find("*:not(.writer-embed, .writer-embed *, .writer-embed-loader)").each(function(){-1==t.inArray(this.nodeName.toLowerCase(),i)||this.tagUrn?(t(this).contents().unwrap(),t(this).remove()):(parseFloat(this.style.textIndent)&&t(this).prepend("&nbsp;&nbsp;&nbsp;&nbsp;"),this.style.textAlign&&(this.align=this.style.textAlign),n.sanitize_attributes(this))}),Browser.isGecko){e=document.createTreeWalker(this.$node[0],128,null,!1);for(var o=[];e.nextNode();)o.push(e.currentNode);t(o).remove()}if(document.createTreeWalker){e=document.createTreeWalker(this.$node[0],4,null,!1);for(var s;s=e.nextNode();){var r=s.nodeValue,a=r.replace(/[\r\n\t ]+/g," ");a!=r&&(s.nodeValue=a)}}this.endEdit()},onPaste:function(e){var n,o;if(this.beginEdit("paste"),e.originalEvent&&e.originalEvent.clipboardData&&e.originalEvent.clipboardData.getData){var s=e.originalEvent,r=s.clipboardData&&s.clipboardData.types&&t.makeArray(s.clipboardData.types);if(!r||!/text\/plain/.test(r)||/text\/html/.test(r)&&!Browser.isOpera||/text\/rtf/.test(r)||/text\/uri-list/.test(r)){if(Browser.isKHTML&&/text\/html/.test(r)){o=s.clipboardData.getData("text/html");var a=t("<div>").append(i(o)),h=1==a.children(":not(meta)").length&&!t.grep(a.contents(),function(e){return 1==e.nodeType?"META"!=e.tagName&&("A"!=e.tagName||e.textContent!=e.href):3==e.nodeType?t.trim(e.nodeValue):void 0}).length;if(h)n=s.clipboardData.getData("text/plain").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),document.execCommand("insertHTML",!1,n),e.preventDefault(),e.stopPropagation();else{var d=a.find("*").filter(function(){return this.src&&"IMG"!=this.tagName&&!WriterEmbed.isTrustedSource(this.src)});d.length&&e.preventDefault()}}else if(/text\/html/.test(r)){this.$node.focus(),o=s.clipboardData.getData("text/html");var l=o.match(/^<([A-Z][A-Z0-9]*)\b[^>]*>([^<>]*?)<\/\1>$/i),c=this.get_selection();c&&l&&l.length&&c.commonAncestorContainer&&c.commonAncestorContainer.nodeName==l[1].toUpperCase()&&(document.execCommand("insertText",!1,l[2]),e.preventDefault(),e.stopPropagation())}}else n=s.clipboardData.getData("text/plain"),-1!=t.inArray("da:embed",this.options.valid_tags)&&n.match(/^\s*<iframe.+>\s*$/i)?n=WriterEmbed.damlFromHtml(n):(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ {2}/g," &nbsp;").replace(/\r?\n/g,"<br>"),-1!=t.inArray("da:thumb",this.options.valid_tags)&&(n=n.replace(/:thumb(\d+):/g,'<da:thumb id="$1"></da:thumb>')),-1!=t.inArray("da:deviation",this.options.valid_tags)&&(n=n.replace(/:bigthumb(\d+):/g,'<da:deviation id="$1"></da:deviation>'))),/<[^>]+>/.test(n)||/&lt;.+&gt;/.test(n)?document.execCommand("insertHTML",!1,n):document.execCommand("insertText",!1,n),e.preventDefault(),e.stopPropagation()}setTimeout(this.onPasteFinished.bindTo(this),0)},onCut:function(){this.beginEdit("cut"),setTimeout(t.proxy(this,"endEdit"),0)},onClick:function(){this.clearDefault(),u.active=this},sync:function(){this.sync_queued&&clearTimeout(this._sync_timer),this.sync_queued=!1;var t=this.syncer.sync(this.inHtmlMode());return t&&this.isDirty()&&u.active&&(t=this.saveContent()),this.update_placeholder(),PubSub.publish("Writer.sync",t),t},scheduleSync:function(){this.sync_queued&&clearTimeout(this._sync_timer),this.sync_queued=!0,this._sync_timer=setTimeout(t.proxy(this,"sync"),this.options.sync_timeout)},onBlur:function(){this.scheduleSync(),this.update_placeholder()},onKeyUp:function(){this.scheduleSync(),this.remember_selection()},onChange:function(){this.scheduleSync()},create:function(e){return this.$node=t("#"+this.id),0===this.$node.length&&(this.$node=t("<div></div>",{id:this.id,"class":"writer no-lub put-art-here"}).css("padding-bottom","1em").data("writer",this),e.removeAttr("style").addClass("writer")),this.visible=!1,this.$node.hide(),this.createToolbars(e),this.$node},createToolbars:function(t,e){this.toolbars=[];var i,n,o;if(e)for(o in e)i=this.id+"/"+e[o].toolbar_name,n=Toolbars[i]?Toolbars[i]:new WriterToolbar(i,this.$node,this.sync.bindTo(this),e[o]),this.toolbars.push(n);else if(t&&t.attr("toolbar")){i=t.attr("toolbar");for(o in Toolbars)o.split("/")[0]==i&&(Toolbars[o].rebind(),this.toolbars.push(Toolbars[o]));if(0===this.toolbars.length){var s=this.options.toolbars&&this.options.toolbars.length?this.options.toolbars[0]:{};this.toolbars.push(new WriterToolbar(i,this.$node,this.sync.bindTo(this),s))}}else if(this.options.toolbars)for(o in this.options.toolbars)i=this.id+"/"+this.options.toolbars[o].toolbar_name,n=Toolbars[i]?Toolbars[i]:new WriterToolbar(i,this.$node,this.sync.bindTo(this),this.options.toolbars[o]),this.toolbars.push(n)},destroy:function(){t.each(this.toolbars,function(t,e){e.destroy()}),this.image_controls&&this.image_controls.hide(!0),this.$node.remove(),this.$textarea.show()},attach:function(e){var i=this;if(this.$textarea=e,this.$textarea.val()==this.$textarea.attr("placeholder")&&this.$textarea.val(""),this.$textarea.height()&&(this.$node[0].style.minHeight=this.$textarea.height()+"px"),this.options.match_textarea_width&&(this.$node[0].style.width=this.$textarea.width()+"px"),this.$node.insertBefore(this.$textarea),this.visible&&this.show(),this.image_controls?this.image_controls.attach(this):this.image_controls=new WriterImageControls(this,this.options.imagecontrol_options),this.$node.add(this.$textarea).off(".writer"),this.$node.is(":ui-droppable")||this.$node.droppable({tolerance:"pointer",accept:function(t){return t.closest(".stash-sidebar").length>0},over:function(){u.active=i,i.restore_selection()},drop:function(t,e){i.remember_selection(),i.insert_thumb(e.draggable)}}),this.history.bindEvents(),this.$node.data("writer",this),this.$node.on("click.writer",this.onClick.bindTo(this)),this.$node.on("blur.writer",this.onBlur.bindTo(this)),this.$node.on("paste.writer",this.onPaste.bindTo(this)),this.$node.on("cut.writer",this.onCut.bindTo(this)),this.$node.on("keyup.writer",this.onKeyUp.bindTo(this)),this.$node.on("change.writer",this.onChange.bindTo(this)),this.$textarea.on("blur.writer",this.onBlur.bindTo(this)),this.$textarea.on("keyup.writer",this.onKeyUp.bindTo(this)),this.$node.on("click.writer","a",function(t){t.preventDefault()}),this.$node.on("keydown.writer",bind(this,function(t){if(!this.autocomplete||!this.autocomplete.isShown()){var e=t.metaKey||t.ctrlKey||t.altKey||t.shiftKey;69!==t.which||!t.metaKey&&!t.ctrlKey||t.altKey||t.shiftKey?13!=t.which||e?9!=t.which||this.options.passthrough_tab?190!=t.which||!t.metaKey&&!t.ctrlKey||t.altKey||t.shiftKey?32!=t.which||!t.ctrlKey||t.metaKey||t.altKey||t.shiftKey?this.options.block_sidescroll&&h(this.$node[0],t):(t.preventDefault(),this.removeFormatting()):(t.preventDefault(),t.stopPropagation(),PubSub.publish("WriterSidebar.show_emoticons")):e?!t.shiftKey||t.metaKey||t.ctrlKey||t.altKey||(t.preventDefault(),this.outdent()):(t.preventDefault(),this.indent()):s()&&t.preventDefault():(t.preventDefault(),t.stopPropagation(),this.switchToHtmlMode()),this._fix_caret_after_inline_blocks()}})).on("drop.writer",bind(this,function(){setTimeout(this.onPasteFinished.bindTo(this),0)})),this.$textarea.on("keydown.writer",bind(this,function(t){69!==t.which||!t.metaKey&&!t.ctrlKey||t.altKey||t.shiftKey?this.options.passthrough_tab||9!==t.which||t.metaKey||t.ctrlKey||t.altKey||t.shiftKey||(t.preventDefault(),n(t.target,"&nbsp; &nbsp; ")):(t.preventDefault(),t.stopPropagation(),this.switchToRichMode())})),this.autocomplete=new DAutoComplete(this.$node,this.options.autocomplete_priority),vms_feature("writer_link_editor")&&(this.link_editor=new LinkEditor(this.$node)),this.options.content&&this.$textarea.val(this.options.content),this.options.draft_id_override&&(this.loadContent(this.options.draft_id_override),this.options.draft_id_override=!1),vms_feature("writer_drag_upload")&&this.options.stash_upload&&window.File){this.$stashform&&this.$stashform.remove();var o=this.$stashform=t('<form method="POST" enctype="multipart/form-data" action="/global/stashpost" autocomplete="off"><input type="file" capture="filesystem" name="file"/></form>').insertAfter(this.$node).hide();PubSub.publish("StashUploader.form_switch",o),this.stash_previous_mode=Glbl("Stash.mode"),Glbl("Stash.mode","plain"),PubSub.publish("StashEmbedded.start");var r=!1;this.$node.on("drop",function(t){var e=t.originalEvent.dataTransfer;e&&e.files&&e.files.length&&(r=!0)}),this.$node.on("dragover.writer",function(e){var i=e.originalEvent.dataTransfer,n=i&&i.types&&t.makeArray(i.types);n&&-1!=n.indexOf("Files")&&-1==n.indexOf("text/plain")&&(this.drag_stash_previous_mode=Glbl("Stash.mode"),Glbl("Stash.mode","plain"))}),this.$node.on("dragleave.writer",function(t){var e=t.originalEvent.dataTransfer;e&&e.files&&e.files.length&&this.drag_stash_previous_mode&&(Glbl("Stash.mode",this.drag_stash_previous_mode),this.drag_stash_previous_mode=null)});var a={starting:function(t,e){if(r){var i=WriterEmbed.loaderFromAttrs({type:"upload",id:e.upload_id});this.insert(i)}},queue_emptied:function(){r=!1},complete:function(t,e){console.log("complete",e);var i=WriterEmbed.loaderFromAttrs({type:"deviation",id:e.response.privateid||e.response.deviationid,format:this.insert_thumbs?this.insert_thumb_format||"thumb":"auto"});this.$node.find('.writer-embed-loader[data-embed-id="'+e.upload_id+'"]').replaceWith(i),WriterEmbed.runLoaders(this.$node)},error:function(t,e){this.$node.find('.writer-embed-loader[data-embed-id="'+e.upload_id+'"]').remove()}};PubSub.subscribe([{eventname:"StashUploader.starting",subscriber:this,callback:a.starting},{eventname:"StashUploader.complete",subscriber:this,callback:a.complete},{eventname:"StashUploader.error",subscriber:this,callback:a.error},{eventname:"StashUploader.queue_emptied",subscriber:this,callback:a.queue_emptied}])}u.active=this;for(var d in this.toolbars)this.toolbars[d].rebind()},is_empty:function(){return 0===this.$node.find("img").length&&this.storage.is_empty()},update_placeholder:function(){this.is_empty()&&this.$node[0]!=document.activeElement&&this.visible?(this.$node.addClass("empty"),this.$textarea.addClass("empty")):(this.$node.removeClass("empty"),this.$textarea.removeClass("empty"))},toggle:function(t){this.visible?this.hide(t):this.show(t)},show:function(e){this.visible=!0,this.$node[0].setAttribute("contentEditable","true"),this.$node.show();try{document.execCommand("styleWithCSS",0,!1)}catch(i){try{document.execCommand("useCSS",0,!0)}catch(n){try{document.execCommand("styleWithCSS",!1,!1)}catch(o){}}}this.$textarea.hide(),e&&this.syncer.sync(!0),t.each(this.toolbars,function(t,e){e.show()}),this.update_placeholder()},hide:function(e){this.visible=!1,this.image_controls.hide(!0),this.$node[0].removeAttribute("contentEditable"),this.$node.hide(),this.$textarea.show(),e&&(this.syncer.sync(),this.saveContent()),t.each(this.toolbars,function(t,e){e.hide()}),this.update_placeholder()},inRichMode:function(){return"rich"==this.editingMode},inHtmlMode:function(){return"html"==this.editingMode},switchToHtmlMode:function(){this.options.allow_html_mode&&(this.editingMode="html",this.image_controls.hide(!0),this.$node[0].removeAttribute("contentEditable"),this.$node.hide(),this.$textarea.show(),this.$textarea.focus(),this.move_caret_to_end(this.$textarea[0]),this.syncer.sync(),this.saveContent(),this.options.on_switch_editing_mode())},switchToRichMode:function(){this.editingMode="rich",this.$textarea.hide(),this.$node.attr("contentEditable","true"),this.$node.show(),this.$node.focus(),this.syncer.sync(!0),this.options.on_switch_editing_mode(),this.move_caret_to_end(this.$node[0])},enforceRichMode:function(){if(this.inRichMode())return!0;if(!this._modal){var t=this._modal=Modals.factory("<div class='pppp'>This feature is only available in Rich Editing mode. Would you like to switch to it?</div>",{showCloseButton:!1,showButtonsSeparator:!1});t.addButton("No"),t.addButton("Yes","smbutton-green",function(){u.active.switchToRichMode(),Modals.pop("ok")})}return Modals.topModal()!=this._modal&&Modals.push(this._modal),!1},insert:function(t){return this.enforceRichMode()?(this.beginEdit("insert_html"),this._insert_into_selection(t),this.scheduleSync(),this):void 0},insert_thumb:function(e){var i=u.active,n=t(e).attr("collect_rid").split(":");switch(n[2]=n[2]||"",n[0]){case 23:case"23":case 36:case"36":case"portfolio":i.insert(t("<img>",{"class":"portfoliofile gr-shrink",id:n[1],src:t(e).find("a.thumb").data("super-img")}));break;case"bing":i.insert(t("<img>",{"class":"portfoliofile gr-shrink",src:t(e).attr("data-fullsize")}));break;default:var o={type:"deviation",id:n[1],format:i.insert_thumbs?i.insert_thumb_format||"thumb":"auto"},s=!i.insert_thumbs;("emote"==n[0]||"emote"==n[2])&&(o.type="emoticon",o.format="thumb",1==n[0]&&(o.profile="deviation"),s=!1),i.insert([WriterEmbed.loaderFromAttrs(o),s?"<br><br>":"&nbsp;"]),WriterEmbed.runLoaders(i.$node)}},setFocusAfter:function(t){if(window.getSelection){var e=window.getSelection(),i=document.createRange();i.setStartAfter(t),e.removeAllRanges(),e.addRange(i),this.has_focus()||this.$node.focus()}},_insert_into_selection:function(e){e=t("<div>").html(e)[0],this.restore_selection();var i=this.get_selection();if(i)if(document.selection)document.selection.createRange(0).pasteHTML(e.innerHTML);else{for(i.deleteContents();e.lastChild;)i.insertNode(e.lastChild);i.collapse(!1),window.getSelection().removeAllRanges(),window.getSelection().addRange(i)}else this.$node.append(e.innerHTML);this._fix_caret_after_inline_blocks()},has_focus:function(){return this.$node[0]==document.activeElement},get_selection:function(){var t,e,i;if(this.has_focus())return window.getSelection?(t=window.getSelection(),e=t.rangeCount?t.getRangeAt(0):null,i=e&&e.commonAncestorContainer):document.selection&&"Control"!=document.selection.type&&(e=document.selection.createRange(0),i=e.parentElement()),i&&3==i.nodeType&&(i=i.parentNode),i&&this.$node[0].contains(i)?e:void 0},get_selection_parent:function(t){var e=t.commonAncestorContainer||t.parentElement();return 3==e.nodeType&&(e=e.parentNode),e},get_textarea_selection:function(){var t=this.$textarea[0];return{start:t.selectionStart,end:t.selectionEnd,scrollTop:t.scrollTop}},remember_selection:function(){this._selection=this.get_selection()||this._selection},restore_selection:function(){var t,e=this._selection;this.has_focus()||(e?window.getSelection?(t=window.getSelection(),t.removeAllRanges(),t.addRange(e)):document.selection&&e.select():this.move_caret_to_end(this.$node[0]),this.has_focus()||this.$node.focus())},restore_textarea_selection:function(t){var e=this.$textarea[0];e.selectionStart=t.start,e.selectionEnd=t.end,e.scrollTop=t.scrollTop},move_caret_to_end:function(e){var i,n;window.getSelection?(n=document.createRange(),n.selectNodeContents(e),n.collapse(!1),i=window.getSelection(),i.removeAllRanges(),i.addRange(n)):document.selection&&(n=document.body.createTextRange(),n.moveToElementText(e),n.collapse(!1),n.select()),e!==document.activeElement&&t(e).focus()},removeFormatting:function(){this.beginEdit(),document.execCommand("removeFormat",!1,null);try{var e,i="h1,h2,h3,h4,h5,h6,blockquote,pre",n=this.get_selection();0===n.startOffset&&n.commonAncestorContainer.nodeName.match(/^h\d$/i)&&""+n===t(n.commonAncestorContainer).text()?(e=t(n.commonAncestorContainer).find(i).replaceWith(function(){return this.innerHTML}).end().html(),t(n.commonAncestorContainer).replaceWith(e)):(e=n.extractContents(),t(e.querySelectorAll(i)).replaceWith(function(){return this.innerHTML}),n.insertNode(e))}catch(o){}this.endEdit()},align:function(t){this.beginEdit("align"),this.restore_selection(),document.execCommand("justify"+t,!1,null),Browser.isKHTML&&this.$node.find("*:not(.writer-embed, .writer-embed *)").each(function(){this.style.textAlign&&(this.align=this.style.textAlign,this.style.textAlign="",""===this.getAttribute("style")&&this.removeAttribute("style"))}),this.endEdit()},toggleBlockquote:function(){this.beginEdit(),this.restore_selection();var e=t(this.get_selection_parent(this.get_selection())).closest("blockquote");if(e.length)e.replaceWith(t("<div>").html(e.html()));else{document.execCommand("formatBlock",!1,"<blockquote>")||document.execCommand("indent",!1,""),r();var i=document.selection?document.selection.createRange().parentElement():window.getSelection().anchorNode;e=t(i).closest("blockquote"),e.length&&!e.next().height()&&e.after("<br>")}this.endEdit()},floatSelection:function(t){if(window.getSelection){this.restore_selection();var e=this.get_selection();if(e&&!e.collapsed){var i=document.createElement("div");i.className="float-"+t,this.beginEdit(),i.appendChild(e.extractContents()),e.insertNode(i),e.selectNodeContents(i),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),this.endEdit()}}},setHeadingSize:function(t){this.beginEdit(),document.execCommand("formatBlock",!1,"<"+(t?"h"+t:"div")+">"),this.endEdit()},addLink:function(e,i){if(i=t.trim(i)||e.replace(/^(.{30}).+$/,"$1…"),this.restore_selection(),!window.getSelection)return document.execCommand("createLink",!1,e),void 0;
var n=this.get_selection(),o=t(n.commonAncestorContainer).closest("a");o.length?(i!=o.text()&&o.text(i),o.attr("href",e)):(i!=t.trim(""+n)&&(n.deleteContents(),n.insertNode(document.createTextNode(i))),window.getSelection().removeAllRanges(),window.getSelection().addRange(n),document.execCommand("createLink",!1,e),o=t(n.commonAncestorContainer).closest("a")),o.toggleClass("external",!PHP.isSafeURL(e))},_fix_caret_after_inline_blocks:function(){if(Browser.isIE8){var e=this.$node;setTimeout(function(){var i,n;try{n=document.selection.createRange(),n.expand("character",1);var o=n.parentElement();i="IMG"==o.tagName&&!o.nextSibling}catch(s){i=!1}e.find("img").each(function(){var e=this.nextSibling;(!e||!e.nodeType||1==e.nodeType&&"block"==e.currentStyle.display)&&t(this).after(" ")}),i&&(n.collapse(!1),n.select())},0)}},scrollSelectionIntoView:function(){var e,i,n,o,s,r,a,h,d,l;if(document.selection)return document.selection.createRange().scrollIntoView(),!0;if(e=window.getSelection(),!e.focusNode)return!1;if(i=document.createRange(),i.setStart(e.focusNode,e.focusOffset),Browser.isOpera&&1==i.startContainer.nodeType)return!1;if(n=t('<span style="visibility: hidden">​</span>')[0],i.insertNode(n),o=n,n.scrollIntoViewIfNeeded)n.scrollIntoViewIfNeeded(!0);else for(;o!=window;){if(o=o.parentNode||window,o===window)h=0,d=t(o).height();else{if(!(o.scrollHeight>o.clientHeight&&/scroll|auto/.test(t(o).css("overflow"))))continue;s=o.getBoundingClientRect(),h=s.top,d=s.bottom}s=n.getBoundingClientRect(),r=s.top,a=s.bottom,l=t(o).scrollTop(),h>r?t(o).scrollTop(l+r-h-20):a>d&&t(o).scrollTop(l+a-d+20)}return o=n.parentNode,o.removeChild(n),o.normalize(),!0},frame:function(e,i){var n,o=t("<iframe>",{src:e,css:{background:"white",position:"fixed",top:"100%",left:0,"z-index":1e3,width:"100%",height:"100%",border:"0px solid black"}}).appendTo("body"),s={$:o,act:function(t){this["do_"+t]&&this["do_"+t]()},do_show:function(){o.focus().animate({top:"0%"},400),this.hidden=!1},do_hide:function(){o.animate({top:"100%"},400),this.hidden=!0},do_remove:function(){t(window).off("message.writer",a),this.do_hide(),o.promise().done(function(){o.remove()})}};n=setTimeout(function(){o.remove()},6e4),i||(i=function(t){switch(t.action){case"ready":return"show";case"done":return"remove"}});var r=(e.match(/^(https?:\/\/[^\/]+)/)||[])[1],a=bind(this,function(t){if(t.originalEvent.origin!==r)return console.log("skipping postmessage because of origin",t.originalEvent.origin,r),void 0;t.originalEvent.source!=o[0].contentWindow&&console.log("skipping postmessage because of exact frame match",t.target,o[0].contentWindow),n&&(n=clearTimeout(n));var e=i(t.originalEvent.data,s);s.act(e)});t(window).on("message.writer",a)},indent:function(){this.beginEdit("indent"),a()?document.execCommand("indent",!1):document.selection?document.selection.createRange(0).pasteHTML("&nbsp; &nbsp; "):document.execCommand("insertHTML",!1,"&nbsp; &nbsp; "),this.endEdit()},outdent:function(){a()&&(this.beginEdit("outdent"),document.execCommand("outdent",!1),this.endEdit())}},{active:!1,DefaultStorage:l,DefaultSyncer:d,NoSaveStorage:c,DraftHandler:Base.extend({constructor:function(t){this.writer=t},do_new:function(){this.writer.storage.clear(),this.writer.setContent("")},do_save:function(){this.writer.is_empty()||this.writer.sync()},do_load:function(t){this.writer.loadContent(t)}})});t(document).keydown(function(e){if(u.active){var i="true"==document.activeElement.contentEditable||t(document.activeElement).is("textarea, input:text"),n=document.selection&&"Control"==document.selection.type;return 8!=e.which||i&&!n}}),t(document).bind("mousedown mouseup",function(){u.active&&u.active.remember_selection()}),PubSub.subscribe({eventname:"WriterSidebar.cancel_interaction",subscriber:"Writer",callback:function(){u.active&&u.active.restore_selection()}})})($),window.DWait&&DWait.run("jms/lib/writer/writer.js")});
DWait.ready(["jms/lib/Base.js","jms/lib/browser.js","jms/lib/jquery/jquery.current.js","jms/lib/pager.js","jms/lib/php.js","jms/chrome/autobob.js","jms/pages/skin_edit_base.js","jms/lib/spinpreset.js"],function(){window.WriterSkinbar=SkinEditBase.extend({default_skin:-39,default_options:{sections:["history","groups"].concat(vms_feature("inazar")?"browse":[]),initial_selection:"history",height_drop:202},handlers:{preview_skin:function(i,s){this.options.preview(s)},display_skin:function(i,s){var t=+s.id||this.default_skin;if(s.refresh){var e=this.modes.history;e.reset(),e.fetch_callback=bind(e,function(){this.sidebar.click_callback(this.$stream.find('[collect_rid="33:'+t+'"]'),s.override)}),e.display(!0)}else this.click_callback(this.modes.history.$main.find('[collect_rid="33:'+t+'"]'),s.override)},resize:function(){var i=this.options.height_drop;this.$.find(".types-main").css("height","").height($(window).height()-i),this.$.find(".scroll-container.inner-scroll").height($(window).height()-i-72)}},constructor:function(i,s,t){this.options=$.extend(!0,{},this.default_options,t),this.$=$(i),this.$.append(['<div class="types-container">','<div class="types-overview"><ul></ul></div>','<div class="types-main"><div class="types-main-inside">','<div id="stashwriter_sidebar_skins" style="height:100%;margin:0">','<div class="skins-content"></div>',"</div>","</div></div>","</div>"].join("\n")),this.click_callback=s,this.temporary_skin=0,this.modes={};for(var e=0;this.options.sections.length>e;e++)this.modes[this.options.sections[e]]=new a[this.options.sections[e]](this);this.$.find(".types-overview ul").append(['<li class="edit-skin-item">','<span class="a edit-skin" href="#edit-skin">Edit skin</span>',"</li>"].join("\n")),this.$.find(".edit-skin").click(this.editSkin.bindTo(this)),this.$.find(".apply-skin").remove(),this.$.keydown(bind(this,function(i){27==i.keyCode&&(i.preventDefault(),i.stopPropagation(),Writer.active.restore_selection())}));var n=new Spinner(SpinnerPresets.green);this.$.data("spinner",n);var r=this;PubSub.subscribe([{eventname:"SkinEditModal.preview",subscriber:r,callback:this.handlers.preview_skin}]),PubSub.subscribe([{eventname:"SkinEditModal.display",subscriber:r,callback:this.handlers.display_skin}]),PubSub.subscribe([{eventname:"Skinbar.resize",subscriber:r,callback:this.handlers.resize}]),PubSub.publish("Skinbar.resize")},destroy:function(){PubSub.unsubscribe([{eventname:"SkinEditModal.preview",subscriber:this},{eventname:"SkinEditModal.display",subscriber:this},{eventname:"Skinbar.resize",subscriber:this}]),this.$.remove(),this.$=null},display:function(i){i=i||this.options.initial_selection,this.modes[i]&&(this.top(),this.modes[i].display())},top:function(){this.active&&this.active.close(!0)},editSkin:function(i){i.preventDefault(),i.stopPropagation(),PubSub.publish("SkinEditModal.show",{show_apply:!1})},back_click:function(i){i.preventDefault(),i.stopPropagation(),$("#stashwriter_sidebar_skins_container .types-back").click()},applySkin:function(){this.temporary_skin&&(this.temporary_skin=0,this.$.find(".apply-skin").addClass("disabled"))},setHistoryHighlight:function(i){i=i||this.default_skin,this.modes.history.initial_highlight=i,this.modes.history.fetched&&this.modes.history.$main.find('[collect_rid="33:'+i+'"]').addClass("active")}});var i=Base.extend({fetched:!1,fetch_callback:null,initial_highlight:null,query:"",offset:0,count:20,constructor:function(i){this.sidebar=i,this.$item=this.render_list_item(),this.$main=this.render_main().hide(),this.$stream=this.$main.find(".stream"),i.$.find(".types-overview ul").append(this.$item),i.$.find(".skins-content").append(this.$main),this.bind()},type_name:function(){return this.name||this.label.toLowerCase().replace(/[^a-z_\-]/g,"")},render_list_item:function(){var i=$("<li>",{"class":"writer-skinbar-type-"+this.type_name(),html:"<span>"+this.label+"</span>"}).data("sidebar-type",this);return i},render_main:function(){var i=$(['<div class="scroll-container writer-skinbar-main-'+this.type_name()+'">','<div class="status"><div class="inner"><b></b><span></span></div></div>','<div class="stream stash-stream skins-stream"></div>',"</div>"].join("\n")).data("sidebar-type",this);return i},status:function(i,s,t){clearTimeout(this.status_show_timeout),clearTimeout(this.status_hide_timeout),this.status_show_timeout=setTimeout(bind(this,function(){var t=this.$main.find(".status");t.find("span").html(i),s?(this.spinner=this.spinner||new Spinner($.extend({},SpinnerPresets.green,{left:0,top:0})),this.spinner.spin(t.find("b")[0])):this.spinner&&this.spinner.stop(),t.show()}),300),t&&(this.status_hide_timeout=setTimeout($.proxy(this,"hide_status"),2e3))},hide_status:function(){clearTimeout(this.status_show_timeout),clearTimeout(this.status_hide_timeout),this.$main.find(".status").hide(),this.spinner&&this.spinner.stop()},reset:function(){this.fetched=!1,this.fetch_callback=null,this.offset=0,this.query=""},display:function(){this.sidebar.active&&this.sidebar.active.close(!0),this.sidebar.active=this,this.sidebar.$.find(".types-overview li").removeClass("active"),this.$item.addClass("active"),this.sidebar.$.find('div[class^="writer-skinbar-main-"]').hide(),this.$main.show(),this.$main.find(".scroll-container.inner-scroll").length&&this.$main.find(".scroll-container.inner-scroll").css({height:this.$main.height()-67+"px",width:"auto"})},close:function(){return this.sidebar.active=!1,this.sidebar.$.find(".types-overview li").removeClass("active"),this.$main.hide(),!0},bind:function(){this.$item.click(bind(this,this.item_click)),this.$main.delegate(".stream div.resource-skin","click",bind(this,this.stream_click)).delegate(".stream div.resource-skin","dragstart",function(){return!1}),this.$main.find(".more .smbutton").click(bind(this,this.more_click))},item_click:function(i){i.preventDefault(),this.display()},stream_click:function(i){i.preventDefault(),this.initial_highlight=null;var s=$(i.target).closest("[collect_rid]");return s.hasClass("fakeskin")?!1:(this.sidebar.$.find(".apply-skin").removeClass("disabled"),this.sidebar.click_callback(s),void 0)},more_click:function(i){return i.preventDefault(),!1},skinstream:function(i,s,t){if(s=s||!1,this.$stream.empty(),s&&$('<div class="tt-a stash-tt-a resource-skin" collect_rid="33:'+this.sidebar.default_skin+'"><span class="tt-w"><span class="shadow"><a title="None" href="http://www.deviantart.com/darelated/deviantartskin/journalcss/journal/" target="_blank"><img height="50" width="50" src="//st.deviantart.net/minish/submit/stashwriter-noskin-1.png?55"></a></span></span><a class="t" title="None">No skin</a></div>').appendTo(this.$stream).hover(function(){var i=$(this).find("img");i.attr("src",i.attr("src").replace("noskin-1.png","noskin-2.png"))},function(){var i=$(this).find("img");i.attr("src",i.attr("src").replace("noskin-2.png","noskin-1.png"))}),s&&!window.deviantART.deviant.subbed&&($(this.$stream).parent().prepend('<div class="upsell-container-skin"><a class="upsell-button" href="https://www.deviantart.com/checkout/?mx=premium&subpref=22870_0&point=writersidebarskins" data-quicktip-title="Upgrade to Premium Membership" onclick="PubSub.publish(\'DaGa.track_event_link\', { event: event, element: this, category : \'PremiumUpsell\', action: \'Journal\'});" data-quicktip-text="to enable Journal Skins!" onmouseover="if (window.QuickTip)QuickTip.show(this, \'subby\')"></a><div>'),0===i.length&&($('<div class="tt-a resource-skin stash-tt-a fakeskin" collect_rid="33:9621126" deviationid="126465413"><span class="tt-w"><span class="shadow"><a class="thumb" title="Fella Journalskin v3" href="33:9621126"><img src="http://th08.deviantart.net/fs49/150/i/2009/184/a/1/Fella_Journalskin_v3_by_mindfuckx.png" width="72" height="150"></a></span><a class="t">Fella Journalskin v3</a><small class="l">by `<a class="u" href="http://janvanlysebettens.deviantart.com/">janvanlysebettens</a></small></span></div>').appendTo(this.$stream),$('<div class="tt-a resource-skin stash-tt-a fakeskin" collect_rid="33:9621125" deviationid="281111648"><span class="tt-w"><span class="shadow"><a class="thumb" title="Notebook - Journal Skin" href="33:9621125"><img src="http://th05.deviantart.net/fs70/150/i/2012/023/1/4/notebook___journal_skin_by_detrans-d4nd74w.png" width="129" height="150"></a></span><a class="t">Notebook - Journal Skin</a><small class="l">by *<a class="u" href="http://detrans.deviantart.com/">detrans</a></small></span></div>').appendTo(this.$stream),$('<div class="tt-a resource-skin stash-tt-a fakeskin" collect_rid="33:9621124" deviationid="190645175"><span class="tt-w"><span class="shadow"><a class="thumb" title="Air Mail" href="33:9621124"><img src="http://th08.deviantart.net/fs70/150/i/2012/264/8/7/air_mail_by_ikue-d35i6rb.png" width="128" height="150"></a></span><a class="t">Air Mail</a><small class="l">by $<a class="u" href="http://ikue.deviantart.com/">Ikue</a></small></span></div>').appendTo(this.$stream))),t)for(var e=i.length-1;e>=0;e--){var a=$(i[e][2]);a.find("a.thumb").attr("href","http://www.deviantart.com/deviation/"+a.attr("deviationid")),a.addClass("resource-skin stash-tt-a").appendTo(this.$stream)}else for(var e=0;i.length>e;e++){var a=$(i[e][2]);a.find("a.thumb").attr("href","http://www.deviantart.com/deviation/"+a.attr("deviationid")),a.addClass("resource-skin stash-tt-a").appendTo(this.$stream)}},fetch:function(i,s){this.status("Loading",!0),i&&(this.query=i),s&&(this.offset=s),DiFi.pushPrivateGet("Resources","htmlFromQuery",[this.query,this.offset,this.count,"thumb150","artist:0,title:1,skinasdeviation:1"],bind(this,this.loaded_stream)),DiFi.send()},fix_stream_size:function(){this.$stream.parent().is(".zoom-fix")||this.$stream.wrap('<div class="zoom-fix" style="width: 410px; overflow: hidden;"></div>'),this.$stream.height()&&this.$stream.parent().height(.666666*this.$stream.height()+20)},reset_stream_size:function(){this.$main.find(".zoom-fix").css("height","")}}),s=i.extend({label:"Browse",count:20,constructor:function(i){this.base(i),this.$main.find("a.clear").hide()},render_main:function(){var i=$(['<div class="scroll-container writer-skinbar-main-'+this.type_name()+'">','<div class="writer-sidebar-input-container"><input type="text" placeholder="Search skins"/><a class="clear" href="#">Clear</a></div>','<div style="clear:both" class="scroll-container">','<div class="empty-message">Search for skins by name or keyword to get started</div>','<div class="stream stash-stream skins-stream"></div>','<div class="writer-sidebar-status-container"></div>',"</div>","</div>"].join("\n")).data("sidebar-type",this);return i},bind:function(){this.base(),this.$main.find("a.clear").click(bind(this,function(){return this.$main.find("input").val(""),this.$stream.hide(),this.reset_stream_size(),this.$main.find(".empty-message").show(),this.$main.find("a.clear").hide(),!1})),this.$main.find("input").keypress(bind(this,function(i){13==i.which&&(i.preventDefault(),this.$main.find(".empty-message").hide(),this.$stream.empty().show(),this.$main.find("a.clear").show(),this.fetch($(i.target).val()+" in:darelated/deviantartskin/journalcss/journal attribute:css_skin boost:popular",0))}))},loaded_stream:function(i,s){return i?(this.fetched=!0,this.hide_status(),this.skinstream(s.response.content.resources),this.fix_stream_size(),void 0):(this.status("Unable to load skins.",!1,!0),void 0)},stream_click:function(i){i.preventDefault();var s=$(i.target).closest("[collect_rid]");this.$stream.find("[collect_rid]").removeClass("active"),s.addClass("active");var t=+s.attr("collect_rid").split(":")[1];DiFi.pushPost("CSS","installskin",[0,"journal","",t],bind(this,function(i,s){if(!i)return this.status("Installation failed.",!1,!0),void 0;this.sidebar.temporary_skin&&(DiFi.pushPost("CSS","deleteskin",[0,"",this.sidebar.temporary_skin],bind(this,function(i){return i?void 0:(this.status("Removal of previous skin failed.",!1,!0),void 0)})),DiFi.send()),this.sidebar.temporary_skin=s.response.content.itemid,this.sidebar.$.find(".apply-skin").removeClass("disabled");var t=this.sidebar.modes.history;t.reset(),t.fetch_callback=bind(t,function(){this.sidebar.click_callback(this.$stream.find('[collect_rid="33:'+s.response.content.itemid+'"]'))}),t.display(!0)})),DiFi.send()}}),t=i.extend({label:"Groups",count:20,constructor:function(i){this.base(i),this._load_groups()},render_main:function(){var i=$('<div class="scroll-container writer-skinbar-main-'+this.type_name()+'">'+'<div class="status"><div class="inner"><b></b><span></span></div></div>'+'<div class="group-list"></div>'+'<div class="group-header">'+'<div class="types-back"><span>Back</span></div>'+'<div class="types-heading"></div>'+"</div>"+'<div class="stream stash-stream skins-stream"></div>'+"</div>").data("sidebar-type",this);return i},bind:function(){var i=this;this.base(),this.$main.find(".group-list").on("click",".group-item",function(){i._open_group($(this))}),this.$main.find(".group-header .types-back").on("click",function(){i._close_group()})},loaded_stream:function(i,s){return i?(this.hide_status(),this.skinstream(s.response.content.resources),this.$stream.find("[collect_rid]").data("authorid",this._$active_group.data("userid")),this.fix_stream_size(),void 0):(this.status("Unable to load skins.",!1,!0),void 0)},_load_groups:function(){this.status("Loading",!0),DiFi.pushPost("Stash","get_groups_having_skins",[],bind(this,function(i,s){if(!i)return this.status("Unable to load groups.",!1,!1),void 0;this.hide_status();var t=$.map(s.response.content.groups,function(i){return $('<div class="group-item">').data(i).html(PHP.userlink(i.username,"#","/",!0)).get(0)});t.length?this.$main.find(".group-list").append(t):this.$item.hide()})),DiFi.send()},_open_group:function(i){this._$active_group=i,this.$main.find(".group-list").hide(),this.$main.find(".group-header .types-heading").html(PHP.userlink(i.data("username"),"#","/",!0)),this.$main.find(".group-header").show(),this.$stream.empty().show(),this.fetch("installedby:"+i.data("username")+"/journal",0)},_close_group:function(){this._$active_group=null,this.$main.find(".group-header").hide(),this.$stream.empty(),this.reset_stream_size(),this.$main.find(".group-list").show()}}),e=i.extend({label:vms_feature("inazar")?"History":"Installed",display:function(i){i=i||!1,i||this.base(),this.fetched||this.fetch("installedby:"+deviantART.deviant.username+"/journal",0)},loaded_stream:function(i,s){return i?(this.fetched=!0,this.hide_status(),this.skinstream(s.response.content.resources,!0,!0),this.fix_stream_size(),this.fetch_callback&&this.fetch_callback(),this.initial_highlight&&this.highlight_skin(this.initial_highlight),void 0):(this.status("Unable to load skins.",!1,!0),void 0)},highlight_skin:function(i){var s=this.$main.find('[collect_rid="33:'+i+'"]');s.addClass("active"),s.length&&i>0&&this.sidebar.$.find(".skins-content").scrollTop((s.position().top-10)*(Browser.isKHTML?.666667:1))}}),a={browse:s,groups:t,history:e};window.DWait&&DWait.run("jms/lib/writer/skinbar.js")});
function serializeSelection(t){function e(e,n){if(t.contains(e)||t.contains(e.parentNode)){if(3==e.nodeType)for(var i=e;(i=i.previousSibling)&&3==i.nodeType;)n+=i.nodeValue.length;for(var r=n;e&&e!=t;e=e.parentNode){for(var i,o=0;i=e.previousSibling;e=i)o+=3==e.nodeType&&3==i.nodeType?0:1;r=o+","+r}return r}}if(!window.getSelection)try{return rangy.serializeSelection(null,!0,t)}catch(n){return!1}var i=window.getSelection();if(i.rangeCount)var r=i.getRangeAt(0),o=e(r.startContainer,r.startOffset),s=e(r.endContainer,r.endOffset);return o&&s?o+"|"+s:""}function deserializeSelection(t,e){function n(t){for(var n=e,i=0;t.length-1>i;i++)n=n.childNodes[t[i]];return n}if(t){if(!window.getSelection)try{return rangy.deserializeSelection(t,e),!0}catch(i){return!1}var r=t.split("|")[0].split(","),o=t.split("|")[1].split(",");t=window.getSelection();var s=document.createRange();try{return s.setStart(n(r),r.pop()),s.setEnd(n(o),o.pop()),t.removeAllRanges(),t.addRange(s),!0}catch(i){return!1}}}WriterUndo=function(t){this.writer=t,$.extend(this.writer,this.writerMixin),this._undoStack=[],this._redoStack=[],this._currentEdit=null,this._lastSnapshot=null,this._onAfterKeyboardInput=null,this._onAfterKeyboardInputTimeout=null,this._lastKeyEvent=null,this._lastKeyDownEvent=null,this.bindEvents()},WriterUndo.prototype.canUndo=function(){return this._undoStack.length>0},WriterUndo.prototype.canRedo=function(){return this._redoStack.length>0},WriterUndo.prototype.undo=function(){if(this.endEdit(),this.canUndo()){var t=this._undoStack.pop();this._redoStack.push(t),this._lastSnapshot=t.before,this.writer.restoreSnapshot(t.before)}},WriterUndo.prototype.redo=function(){if(this.canRedo()&&this.endEdit(),this.canRedo()){var t=this._redoStack.pop();this._undoStack.push(t),this._lastSnapshot=t.after,this.writer.restoreSnapshot(t.after)}},WriterUndo.prototype.bindEvents=function(){this.writer.$node.off(".writer-undo").on({"keydown.writer-undo":$.proxy(this,"onKeyDown"),"keypress.writer-undo":$.proxy(this,"onKeyPress")})},WriterUndo.prototype.onKeyDown=function(t){if("keydown"==t.type){var e=t;this._lastKeyDownEvent=t,this._lastKeyEvent=t}else var e=this._lastKeyDownEvent;var n=8,i=46,r=89,o=90,s=e.which,h=e.metaKey||e.ctrlKey,a=e.shiftKey,d=e.altKey;s!=o||!h||a||d?s==r&&h&&!a&&!d||s==o&&h&&a&&!d?(this.redo(),t.preventDefault(),t.actedUpon=!0):s==i?(this.onKeyboardInput("forward_delete"),t.actedUpon=!0):s==n&&(this.onKeyboardInput("backward_delete"),t.actedUpon=!0):(this.undo(),t.preventDefault(),t.actedUpon=!0)},WriterUndo.prototype.onKeyPress=function(t){var e=this._lastKeyEvent,n=this._lastKeyDownEvent;if(this._lastKeyEvent=t,!t.metaKey&&!t.ctrlKey||88!=t.which&&118!=t.which){e&&n&&t.type==e.type&&t.which==e.which&&t.shiftKey==e.shiftKey&&t.metaKey==e.metaKey&&t.ctrlKey==e.ctrlKey&&this.onKeyDown(t);var i=e&&"keydown"==e.type&&e.actedUpon||t.actedUpon;t.which&&!i&&this.onKeyboardInput("typing")}},WriterUndo.prototype.onKeyboardInput=function(t){this._onAfterKeyboardInput&&this._onAfterKeyboardInput();var e=this.writer.createSnapshot();this._onAfterKeyboardInput=$.proxy(function(){clearTimeout(this._onAfterKeyboardInputTimeout),this._onAfterKeyboardInput=null,this.beginEdit(t,e)},this),this._onAfterKeyboardInputTimeout=setTimeout(this._onAfterKeyboardInput,0)},WriterUndo.prototype.beginEdit=function(t,e){t=t||"";var n=this.writer.createSnapshot();e&&e.html==n.html||(e&&this._currentEdit&&this._currentEdit.after&&t==this._currentEdit.type&&(!this._lastSnapshot||e.html==this._lastSnapshot.html)&&e.selection==this._currentEdit.after.selection?this._currentEdit.after=n:(this.endEdit(e||n),this._currentEdit=e?{type:t,before:e,after:n}:{type:t,before:n}),this._lastSnapshot=n)},WriterUndo.prototype.endEdit=function(t){t=t||this.writer.createSnapshot(),this._currentEdit&&(this._currentEdit.after||(this._currentEdit.after=t),this._currentEdit.before.html!=this._currentEdit.after.html&&(this._undoStack.push(this._currentEdit),this._redoStack=[],this._lastSnapshot=this._currentEdit.after)),this._lastSnapshot&&t.html!=this._lastSnapshot.html&&(this._undoStack.push({type:"unknown",before:this._lastSnapshot,after:t}),this._redoStack=[]),this._currentEdit=null,this._lastSnapshot=t,this.writer.$node.trigger("writereditcomplete")},WriterUndo.prototype.writerMixin={undo:function(){this.history.undo(),this.remember_selection()},redo:function(){this.history.redo(),this.remember_selection()},beginEdit:function(t){this.history.beginEdit(t)},endEdit:function(){this.history.endEdit(),this.scheduleSync()},createSnapshot:function(){return{html:this.$node.html(),selection:this.has_focus()&&serializeSelection(this.$node[0])}},restoreSnapshot:function(t){this.$node.html(t.html),deserializeSelection(t.selection,this.$node[0])&&this.scrollSelectionIntoView()}},window.getSelection||DWait.ready("jms/lib/rangy/rangy.js",$.noop),window.DWait&&DWait.run("jms/lib/writer/undo.js");
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/Base.js","jms/legacy/modals.js","jms/lib/writer/writer.js","jms/lib/writer/factory.js","jms/lib/sidebar.js","cssms/lib/writer.css","jms/pages/submission.js","jms/pages/skin_edit_base.js","jms/lib/cssvault.js","jms/lib/pubsub.js","jms/lib/spinpreset.js"],function(){(function(t){var i=Base.extend({constructor:function(){this.storage={},this.untitledTitle="Untitled",this.untitledDraftTitle="Untitled Draft"},init:function(i){this.options=i=i||{},t("#journal_body").val(function(){return this.defaultValue}),$subtoolbar=t('<div class="stashwriter-subtoolbar"></div>').prependTo(".stashwriter-container"),t("#stashwriter_main").scroll(function(){$subtoolbar[this.scrollTop?"addClass":"removeClass"]("in-scroll")}),t("#stashwriter_sidebar").css({"background-color":"#f5f5f5"});var n=location.hash.substring(1);n&&(this.options=i={deviation_id:n,skin_id:i.skin_id,skin_authorid:i.skin_authorid,skin:i.skin}),this.Writer=new e,this.Writer.init(this),this.Tabs=new a,this.Tabs.init(this),this.Skins=new r,this.Skins.init(this),this.Sidebar=new s,this.Sidebar.init(this),this.statusNotifier=new DeviationWriterStatusNotifier(this.Writer.writer.storage),this.statusNotifier.getFileMenu=t.proxy(this,"getFileMenu"),this.statusNotifier.getTitle=t.proxy(this,"getJournalTitle"),this.Writer.adjustHeight(),t(window).unbind("resize.stashwriter").bind("resize.stashwriter",function(){this.Writer.adjustHeight()}.bindTo(this)),this.options.skin&&(this.Skins.get(this.options.skin),this.Skins.skinbar.setHistoryHighlight(this.options.skin.id)),t(".stashwriter-submit").on("click.stashwriter",function(t){t.preventDefault(),this.save()}.bindTo(this)),t(".stashwriter-preview, .stashwriter-preview-small").on("click.stashwriter",function(t){t.preventDefault(),this.preview()}.bindTo(this)),t("#stashwriter_main").on("click.stashwriter","a",function(t){t.preventDefault()}),t("#stashwriter_main").on("change.stashwriter","input",function(){this.Writer.writer.sync()}.bindTo(this)),t("#journal-subject").prop("tabindex",1),t("#journal_body").prop("tabindex",2),t("#stashwriter_main .stashwriter-submit").prop("tabindex",3),PubSub.subscribe([{eventname:"Signup.headerRefresh",subscriber:this,callback:bind(this,function(){t.each(this.Writer.writer.toolbars,function(t,i){i.destroy()}),this.Writer.writer.createToolbars(),t.each(this.Writer.writer.toolbars,function(t,i){i.show(),i.rebind()})})}])},reset:function(e){e=e||{},location.hash.substr(1)!=e.deviation_id&&(location.hash=e.deviation_id||""),t("#stashwriter_main, .stashwriter-submit, .stashwriter-preview, .stashwriter-preview-small").off(".stashwriter"),t(".stashwriter-container").empty().replaceWith(t("#stash-container-clean-slate-html").text()),PubSub.unsubscribe({eventname:"Signup.headerRefresh",subscriber:this}),this.statusNotifier.destroy(),window.Writer.active=!1,window.WriterFactory.destroyAll(),window.StashWriter=new i(e),window.StashWriter.init(e)},getJournalMetadata:function(){return{skinid:StashWriter.options.skin_id,skin_authorid:StashWriter.options.skin_authorid}},getJournalTitle:function(){return t("#stashwriter_journal [name=subject]").val()||this.options.title||this.untitledDraftTitle||""},setJournalTitle:function(i){(i==this.untitledDraftTitle||i==this.untitledTitle)&&(i=""),t("#stashwriter_journal [name=subject]").val(i)},set_save_status:function(i){this.is_saving=i,this.statusNotifier.forceAlert=i,t(".stashwriter-submit").toggleClass("loading",i).find("em").text(i?"Saving...":"Done")},save:function(){var t=this.Writer.writer;if(!this.is_saving&&!t.is_empty()){this.set_save_status(!0),t.sync();var i=bind(this,function(e,s){clearTimeout(this.save_timeout),t.storage.onSaveEnd.remove(i),e?this._save(t):(this.set_save_status(!1),"timeout"===s&&alert("An error occurred saving your deviation. Please try again."))});t.storage.onSaveEnd.add(i),this.save_timeout=setTimeout(function(){i(!1,"timeout")},15e3),t.isSaving()||i(!0)}},_save:function(t){if(!t.storage.id())return this.set_save_status(!1),t.is_empty()?void 0:this.options.deviation_id?(this.goto_deviation(this.options.deviation_id,this.options.privateid),void 0):alert("Can't save due to an error");var i=t.storage.id(),e=t.storage.id(!0);if(!this.options.deviation_id||i==this.options.deviation_id)return console.log("draft had, going to",i),t.removeSavedContent(),this.undraft(i),this.goto_deviation(i,e);var s=this.options.deviation_id,r=this.options.privateid,a=this.options.deviation_version;DiFi.pushPost("Stash","update_journal",[s,a,this.getJournalTitle(),t.getContent(),this.getJournalMetadata()],bind(this,function(a,n){if(a)return t.removeSavedContent(!0),this.goto_deviation(s,r),void 0;var o=n.response.content.error&&n.response.content.error.code;if("ERR_VERSION_CONFLICT"==o||"ERR_VERSION_INCREMENT"==o){if(confirm("It looks like someone else has edited this document. If you would like to keep your changes, they can be saved as a new document in your Sta.sh. Otherwise, Sta.sh Writer will now load the other author's version.\n\nWould you like to save your version as a new draft and continue working?"))return t.removeSavedContent(),this.undraft(i),this.goto_deviation(i,e);this.set_save_status(!1),this.reset(this.options)}else this.set_save_status(!1),DiFi.stdErr("An error occurred saving your deviation. Please try again.",n.response.content)})),DiFi.send()},isDirty:function(){return this.Writer&&this.Writer.writer.isDirty()},preview:function(i,e){var s=function(i,e){var s="daWriterPreview";if((!this.preview_window||this.preview_window.closed)&&(this.preview_window=popup(e?i:"",s,600,null,!0)),!this.preview_window)return alert("Preview window has been blocked. Please allow for Sta.sh to open a popup window."),!1;if(i&&e){var r=t("<form>",{method:"post",action:i,target:s});for(var a in e)r.append(t("<input>",{type:"hidden",name:a,value:e[a]}));r.submit()}else i?this.preview_window.location=i:this.preview_window.document.body.innerHTML='<style>body {background: whiteSmoke; font: 27px "Trebuchet MS", Arial, sans-serif;text-align: center; padding-top: 1em;color: #939499;}</style>Loading...';return this.preview_window.focus(),!0};this.preview_timeout&&(clearTimeout(this.preview_timeout),this.preview_timeout=null);var r=this.Writer.writer;if(r.isSaving()||(window.Writer.active!=r&&r.$node.html(window.Writer.active.$node.html()),r.is_empty()||r.sync()),r.isSaving()){if(!e&&(r.is_empty()||!s("")))return;return this.preview_timeout=setTimeout(bind(this,function(){this.preview(i,e=!0)}),300),void 0}var a=r.storage.id()||this.options.deviation_id||"empty";a&&s("/writer/preview/"+encodeURIComponent(a),i&&{preview_skin:"1",skin_label:i.label,skin_head:i.head,skin_foot:i.foot,skin_css:i.css})},goto_deviation:function(t,i){var e="http://sta.sh/0"+parseInt(i||t,10).toString(36),s=[];this.options.referrer&&(s.push("r="+this.options.referrer),s.push("refid="+this.options.refid)),s.length&&(e=e+"?"+s.join("&")),window.location.hash=t,window.location.href=e},undraft:function(t){DiFi._async=!1;var i=function(t,i){t||DiFi.stdErr("Removing document from drafts",i.response.content)};this.options.stackid?DiFi.pushPost("Stashes","move_into",[this.options.stackid,t],i):DiFi.pushPost("Stashes","remove_from_named_stack",[t,"Drafts"],i),this.getJournalTitle()==this.untitledDraftTitle&&DiFi.pushPost("Deviation","UpdateTitle",[t,"Untitled"]),DiFi.send(),DiFi._async=!0},setJournalMood:function(i){t("#journal-mood-label").html(MenuTraffic.getTitles(i).pop()),t("#journal-mood-icon").attr("src",this._extractMoodURL(i)).show()},resetJournalMood:function(){return t("#journal-mood-label").html("(no mood)"),t("#journal-mood-icon").attr("src","").hide(),!1},_extractMoodURL:function(t){var i=-1,e=MenuTraffic.getTitles(t);for(e=e.slice(1);e[++i];)e[i]=e[i].toLowerCase(),e[i]=e[i].replace(/ /g,"_"),e[i]=e[i].replace(/[^a-zA-Z0-9\-\'_]/g,""),"wow"==e[i]&&(e[i]="surprise");return"http://e.deviantart.net/emoticons/moods/"+e.join("/")+".gif"},getFileMenu:function(){return this.Writer.writer.toolbars[0].getItem("file")}}),e=Base.extend({writerInitialized:!1,init:function(i){if(this.global=i,!this.writerInitialized){var e=[],s=this.global.options.deviation_ids;if(s&&s.length)for(var r=0;s.length>r;r++)e.push('<da:deviation id="'+s[r]+'" />'+"\n\n");var a=[{toolbar_name:"writertop",toolbar_node:".stashwriter-toolbar",toolbar_button_class:"headerButton",toolbar_menu_class:"headerMenu gmbutton2",toolbar_popup_class:"stashwriter-toolbar-menu",toolbar_order:["undo","redo","separator","file","edit","secret"]}];a.push({toolbar_name:"writersub",toolbar_node:".stashwriter-subtoolbar",toolbar_button_class:"subToolbarButton",toolbar_menu_class:"subToolbarMenu",toolbar_popup_class:"stashwriter-subtoolbar-menu stashwriter-subtoolbar-menu",toolbar_order:["bold","italic","underline","headings","separator","ul","ol","blockquote","separator","alignl","alignc","alignr","separator","link2","zoom"]});var n=Writer.DraftHandler.extend({do_save:function(){var t=this.writer;window.Writer.active!=t&&t.$node.html(window.Writer.active.$node.html()),this.base()},do_load:function(t){this.do_save(),i.reset({deviation_id:t})},do_new:function(){this.do_save(),i.reset()}}),o={local_storage_id:this.global.options.deviation_id,draft_id_override:this.global.options.deviation_id,content:e.length?e.join(""):!1,content_id:this.global.options.deviation_id,toolbars:a,draft_metadata:bind(this.global,this.global.getJournalMetadata),draft_title:bind(this.global,this.global.getJournalTitle),draft_handler:n,on_load_content:bind(this.global,function(i){this.options.deviation_id=i.id,this.options.title=i.title,this.options.deviation_version=i.version,this.setJournalTitle(i.title),this.Skins.get({id:Number(i.skin.itemid),authorid:Number(i.skin.userid)});var e=!1,s=this.Writer.writer.storage.id();if(s)try{e=!!localStorage.getItem("stashwriter-editing-mode-"+s)}catch(r){}e&&this.Writer.writer.switchToHtmlMode(),t(".stashwriter_actions .ile-shorturl input").val(i.short_url),t(".stashwriter-container").css("visibility","visible")}),on_save_content:bind(this.global,function(i){window.location.hash=i.stashid,t(".stashwriter_actions .ile-shorturl input").val(i.short_url)}),on_remove_content:bind(this.global,function(){window.location.hash="",t(".stashwriter_actions .ile-shorturl input").val("")}),on_switch_editing_mode:bind(this,function(){this.adjustHeight();var t=this.writer.storage.id();if(t){var i="stashwriter-editing-mode-"+t;try{this.writer.inHtmlMode()?localStorage.setItem(i,1):localStorage.removeItem(i)}catch(e){}}}),storage:vms_feature("qunit")?"NoSaveStorage":"DefaultStorage",valid_tags:["br","hr","strong","b","code","sub","sup","small","tt","acronym","a","abbr","strike","em","i","u","ins","span","blockquote","p","bcode","ul","ol","dl","pre","li","cut","div","da:embed","da:deviation","da:thumb","da:bigthumb","da:widget","da:emoticon","da:drawing","img","font","h1","h2","h3","h4","h5","h6"]};"$"==window.deviantART.deviant.symbol&&o.valid_tags.push("table","tbody","tr","td"),this.writer=WriterFactory.toggle("journal_body",o),this.writer.options.draft_id_override||t(".stashwriter-container").css("visibility","visible"),this.writerInitialized=!0,Writer.active.$node.focus(),Writer.active.$node.prop("tabindex",2),t("body").unbind("click.writer_focus").bind("click.writer_focus",function(i){if(!Writer.active.has_focus()){var e=".headerButton, .subToolbarButton, .popup2, #stashwriter_sidebar, .stashwriter_actions, input, div.writer, textarea",s="#stashwriter_sidebar .writer-sidebar-main-emoticons li";t(i.target).closest(s).length?Writer.active.restore_selection():t(i.target).closest(e).length||Writer.active.restore_selection()}})}},adjustHeight:function(){var i=Writer.active.inRichMode()?Writer.active.$node:Writer.active.$textarea,e=t("#stashwriter_main").height()-t("#stashwriter_main_inner").height()-2+i.height();i.css("min-height",e)}}),s=Base.extend({init:function(i){this.global=i,this.sidebar=new WriterSidebar("#stashwriter_sidebar_files",bind(this,function(t){this.global.Writer.writer.insert_thumb(t)}),{drop_zone:t("body"),initial_selection:"stash",upload_thumb:!0})}}),r=SkinEditBase.extend({counter:0,fetched:!1,init:function(i){this.global=i,this.skinbar=new WriterSkinbar("#stashwriter_sidebar_skins_container",bind(this,function(i,e){return i.hasClass("resource-noskin")?(this.remove(),this.global.Writer.adjustHeight(),void 0):(t(".skin-title").text(i.find(".thumb").attr("title")),t("#stashwriter_sidebar_skins .stream").find(".active").removeClass("active"),this.get({id:parseInt(i.attr("collect_rid").split(":")[1],10),authorid:i.data("authorid")||0},e),i.addClass("active"),void 0)}),{preview:function(t){StashWriter.preview(t)}}),t("#stashwriter_sidebar_skins_container").hide()},show:function(){this.skinbar.display()},remove:function(){this.global.options.skin_id&&(Writer.active=this.global.Writer.writer,t("#stashwriter_sidebar_skins .skin-title").text("None"),t("#stashwriter_sidebar_skins .stream").find(".active").removeClass("active"),this.skin_data_to(t("#stashwriter_main .journal-skin-editor"),{jheader:"",jfooter:"",jcss:"",skinid:"",authorid:"",label:""}),this.save_skin(null))},callback:function(i,e){this.fetched=!0;var s=t("#stashwriter_sidebar_skins .stream");if(s.html(""),!i)return s.html("Unable to load skins."),void 0;var r=e.response.content.resources;if(0===r.length)return s.html("No skins found."),void 0;t('<div class="tt-a stash-tt-a resource-skin" collect_rid="33:-39"><span class="tt-w"><span class="shadow"><a title="None" href="http://www.deviantart.com/darelated/deviantartskin/journalcss/journal/" target="_blank"><img height="50" width="50" src="//st.deviantart.net/minish/submit/stashwriter-noskin-1.png?55"></a></span></span><a class="t" title="None">Remove skin</a></div>').appendTo(s).hover(function(){var i=t(this).find("img");i.attr("src",i.attr("src").replace("noskin-1.png","noskin-2.png"))},function(){var i=t(this).find("img");i.attr("src",i.attr("src").replace("noskin-2.png","noskin-1.png"))});for(var a=0;r.length>a;a++)t(r[a][2]).addClass("resource-skin").addClass("stash-tt-a").appendTo(s);t('<div class="tt-aa resource-skin browse-link"><span class="tt-ww"><span class="shadow"><a class="skinthumb" href="http://www.deviantart.com/darelated/deviantartskin/journalcss/journal/" target="_blank"><img height="52" width="52" src="//st.deviantart.net/minish/gruzecontrol/browse-skins.png"></a></span></span></div>').addClass("tt-a").appendTo(s);var n=t(".skin-title");if(this.global.options.skin_id){var o=s.find('div.resource-skin[collect_rid="33:'+this.global.options.skin_id+'"]');o.addClass("active"),n.text(o.find(".skinthumb").attr("title")),s.find('div.resource-skin[collect_rid="33:'+this.global.options.skin_id+'"]').addClass("active")}else n.text("None")},click:function(i){return i.hasClass("resource-noskin")?(this.remove(),this.global.Writer.adjustHeight(),void 0):i.hasClass("browse-link")?window.open(i.closest(".browse-link").find("a").attr("href")):(t(".skin-title").text(i.find("a.t").attr("title")),t("#stashwriter_sidebar_skins .stream").find(".active").removeClass("active"),this.get({id:parseInt(i.attr("collect_rid").split(":")[1],10),authorid:i.data("authorid")||0}),i.addClass("active"),void 0)},get:function(i,e){var s=this;return s.counter++,i.id?(DiFi.pushPost("Journal","get_styled_edit_form_user",[i.authorid,i.id,s.counter,e||{}],bind(this,function(i,e){if(!i)return DiFi.stdErr("Skin loading",e.response.content);CSSVault.free("journal-skinny-"+(s.counter-1)),CSSVault.apply("journal-skinny-"+s.counter,e.response.content.css);var r,a,n,o;Writer.active?(n=Writer.active.inHtmlMode(),n&&(o=Writer.active.get_textarea_selection()),r=Writer.active.getContent(),a=Writer.active.$node.data()):(r=t("#journal_body").val(),a=t("#journal_body").data());var l=this.global.getJournalTitle();(l==this.global.untitledTitle||l==this.global.untitledDraftTitle)&&(l=""),gWebPage.update({deps:e.response.content.deps}),t("#stashwriter_journal").empty().html(e.response.content.html).show();var d=t("#stashwriter_journal").find("[name=subject]");d.val(l),r&&t("#journal_body").val(r);var h=e.response.content.skin;this.skin_data_to(t("#stashwriter_main .journal-skin-editor"),h),t(".skin-title").text(h.label),this.skinbar.setHistoryHighlight(h.itemid),t("#journal_body").attr("toolbar","journal_body-writer"),this.global.Writer.writerInitialized||this.global.Writer.init(this.global);var u=Writer.active;u.attach(t("#journal_body"),!0),u.$node.css({height:"auto",overflow:"auto"}).parent().css({height:"auto"}),u.show(),n&&(u.switchToHtmlMode(),u.restore_textarea_selection(o)),a&&a.states&&(console.log("Setting previous toolbar states: ",a.states),u.$node.data("states",a.states));for(var c in Toolbars)Toolbars[c].rebind();this.save_skin(h),this.global.Writer.adjustHeight()})),DiFi.send(),void 0):(this.remove(),void 0)},save_skin:function(t){t&&t.itemid>0?(this.global.options.skin_id=t.itemid,this.global.options.skin_authorid=t.authorid):(this.global.options.skin_id=0,this.global.options.skin_authorid=0),this.global.options.skin=t||{};var i=this.global.Writer.writer;console.log("resetting contents after skin save"),i.saveContent()},handlers:{preview_skin:function(t,i){this.global.preview(i)},display_skin:function(t,i){this.get(i,i.override)}},editSkin:function(t){t.preventDefault(),t.stopPropagation();var i=this;PubSub.publish("SkinEditModal.show",{show_apply:!1}),PubSub.subscribe([{eventname:"SkinEditModal.preview",subscriber:i,callback:this.handlers.preview_skin}]),PubSub.subscribe([{eventname:"SkinEditModal.display",subscriber:i,callback:this.handlers.display_skin}])}}),a=Base.extend({init:function(i){this.global=i,this.activeTab="stashwriter_sidebar_files_container",t("#stashwriter_sidebar_skins_container").hide(),t("#stashwriter_sidebar_skins_show").click(this.showSkins.bindTo(this));var e=this;PubSub.subscribe([{eventname:"Skinbar.collapse",subscriber:e,callback:this.hideSkins}])},showSkins:function(i){i.preventDefault();var e=this,s=t("#stashwriter_sidebar_files .types-main").height();t("#stashwriter_sidebar_files").addClass("sidebar-collapsed"),t("#stashwriter_sidebar_files .types-main").animate({height:"0px"},"fast",function(){e.global.Sidebar.sidebar.top()}),t("#stashwriter_sidebar_files_container .current-skin").hide(),t("#stashwriter_sidebar_skins_container").show().find(".types-main").css("height","0px").animate({height:s+"px"},"fast"),t("#stashwriter_sidebar_skins").show(),e.global.Skins.show()},hideSkins:function(i,e){this.global.Skins.skinbar.applySkin(),t("#stashwriter_sidebar_skins_container").hide(),t("#stashwriter_sidebar_skins").hide(),t("#stashwriter_sidebar_files_container").show(),t("#stashwriter_sidebar_files").show();var s=this,r=t("#stashwriter_sidebar_skins_container .types-main").height();t("#stashwriter_sidebar_files").removeClass("sidebar-collapsed"),s.global.Sidebar.sidebar.modes[e].display(),t("#stashwriter_sidebar_files .types-main").animate({height:r+"px"},"fast"),t("#stashwriter_sidebar_skins_container .types-main").animate({height:r+"px"},"fast",function(){t("#stashwriter_sidebar_skins_container").hide(),t("#stashwriter_sidebar_files_container .current-skin").show()})}});window.StashWriter=new i,t(window).on("beforeunload",function(){return!StashWriter.is_saving&&StashWriter.isDirty()?"Your draft hasn't been saved yet.":void 0})})(jQuery),window.DWait&&DWait.run("jms/pages/submit/StashWriter.js")});if(window.DWait){DWait.count()}